<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd">

	<changeSet author="EdwardLegaspi" id="#1087_20150922">
		<createTable tableName="meveo_filter_parameter">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="disabled" type="BOOL">
				<constraints nullable="false" />
			</column>
			<column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
			<column name="provider_id" type="BIGINT" />
			<column name="creator_id" type="BIGINT" />
			<column name="updater_id" type="BIGINT" />
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(100)" />
			<column name="default_value" type="VARCHAR(50)" />
			<column name="value_required" type="BOOL" />
			<column name="field_type" type="VARCHAR(255)" />
			<column name="entity_clazz" type="VARCHAR(255)" />
			<column name="filter_id" type="BIGINT" />
		</createTable>

		<addPrimaryKey columnNames="id" constraintName="meveo_filter_parameter_pkey"
			tableName="meveo_filter_parameter" />

		<addForeignKeyConstraint baseColumnNames="provider_id"
			baseTableName="meveo_filter_parameter" constraintName="fk_meveo_filter_parameter_crm_provider"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
		
		<addForeignKeyConstraint baseColumnNames="creator_id"
			baseTableName="meveo_filter_parameter" constraintName="fk_creator_meveo_filter_parameter_adm_user"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		
		<addForeignKeyConstraint baseColumnNames="updater_id"
			baseTableName="meveo_filter_parameter" constraintName="fk_updater_meveo_filter_parameter_adm_user"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		
		<addForeignKeyConstraint baseColumnNames="filter_id"
			baseTableName="meveo_filter_parameter" constraintName="fk_meveo_filter_parameter_meveo_filter"
			deferrable="false" initiallyDeferred="false" onDelete="CASCADE"
			onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="meveo_filter" />

		<createTable tableName="meveo_filter_parameter_list_val">
			<column name="filterparameter_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="listvalues" type="VARCHAR(255)" />
			<column name="listvalues_key" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createSequence sequenceName="meveo_filter_parameter_seq" />
	</changeSet>

	<changeSet author="anasseh" id="20150928_text">
     	<modifyDataType columnName="string_value" newDataType="text"   tableName="CRM_CUSTOM_FIELD_INST"/>
     </changeSet>
    
    <changeSet author="AndriusKarpavicius" id="#1094_20150929">
		<addColumn tableName="CRM_CUSTOM_FIELD_INST">
			<column name="seller_id" type="BIGINT" />
		</addColumn>    
    
    	<addForeignKeyConstraint constraintName="fk_seller_id_crm_custom_field_inst"
			referencedTableName="CRM_SELLER" baseColumnNames="seller_id"
			baseTableName="CRM_CUSTOM_FIELD_INST" referencedColumnNames="id" />
    </changeSet>

    <changeSet author="AndriusKarpavicius" id="#1123_20151006">
        <dropColumn tableName="MEVEO_JOB_INSTANCE" columnName="user_id"/>
    </changeSet>
	 <changeSet author="anasseh" id="#1117_20151005">
		    <addColumn tableName="BILLING_CYCLE">
	            <column name="INVOICING_THRESHOLD" type="numeric(23, 12)" />
	        </addColumn>	
	</changeSet>       
    <changeSet author="anasseh" id="20151009_1149">
        <modifyDataType columnName="SELECTED_BILLING_ACCOUNTS" newDataType="text"   tableName="BILLING_BILLING_RUN"/>
     </changeSet>
     <!--  Commenting it out to solve 4.3.0 migration script issue. Table is later deteled anyway. -->
<!--    	<changeSet author="anasseh" id="20151013_1165"> -->
<!--      	<modifyDataType columnName="MESSAGE" newDataType="text"   tableName="MEVEO_SCRIPT_INSTANCE_ERROR"/> -->
<!--      </changeSet> -->

    <changeSet id="#1150_20151013" author="Mbarek" failOnError="false">
	<addColumn tableName="BILLING_INVOICE_CONFIGURATION">
	<column name="display_provider" type="BOOL" defaultValueBoolean="false"></column>
	</addColumn>
	</changeSet>
	
	  <changeSet id="1201_20151102" author="Mbarek">
		<sql>ALTER TABLE crm_custom_field_tmpl DROP CONSTRAINT IF EXISTS uk_odjxv76fr14lrm19mt961b04p;</sql>
	</changeSet>

    <changeSet id="#1101_20151021" author="AndriusKarpavicius">
        <createSequence sequenceName="CRM_CUSTOM_FIELD_FIELDS_SEQ"/>
        <createTable tableName="CRM_CUSTOM_FIELD_FIELDS">
            <column name="id" type="BIGINT">
                <constraints nullable="false"  />
            </column>
            <column name="version" type="INT4" />        
            <column name="provider_id" type="BIGINT" />
            <column name="UUID" type="VARCHAR(60)" >
                <constraints nullable="false"/>
            </column> 
        </createTable>
        
        <addColumn tableName="CRM_CUSTOM_FIELD_INST">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        
        <addPrimaryKey columnNames="id" constraintName="crm_custom_field_fields_pkey"
            tableName="CRM_CUSTOM_FIELD_FIELDS" />
            
        <addForeignKeyConstraint constraintName="fk_crm_custom_field_inst_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CRM_CUSTOM_FIELD_INST" referencedColumnNames="id" />
        
        <addColumn tableName="MEDINA_ACCESS">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>        
        <addColumn tableName="CRM_PROVIDER">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="ACCOUNT_ENTITY">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="CAT_CHARGE_TEMPLATE">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="MEVEO_JOB_INSTANCE">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="CAT_OFFER_TEMPLATE">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="CRM_SELLER">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="CAT_SERVICE_TEMPLATE">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="BILLING_SUBSCRIPTION">
            <column name="CFF_ID" type="BIGINT"/>
        </addColumn>
        
        <addForeignKeyConstraint constraintName="fk_medina_access_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="MEDINA_ACCESS" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_crm_provider_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CRM_PROVIDER" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_account_entity_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="ACCOUNT_ENTITY" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_cat_charge_template_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CAT_CHARGE_TEMPLATE" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_meveo_job_instance_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="MEVEO_JOB_INSTANCE" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_cat_offer_template_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CAT_OFFER_TEMPLATE" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_crm_seller_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CRM_SELLER" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_cat_service_template_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CAT_SERVICE_TEMPLATE" referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_billing_subscription_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="BILLING_SUBSCRIPTION" referencedColumnNames="id" />
        
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'provider_'||cfi_ent_id, cfi_ent_id from (select distinct provider_id as cfi_ent_id from crm_custom_field_inst where provider_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='provider_'||crm_custom_field_inst.provider_id) where provider_id is not null;
            update crm_provider set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='provider_'||crm_provider.id);
        </sql>        
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'access_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct medina_access.id as cfi_ent_id, medina_access.provider_id as cfi_ent_provider_id from crm_custom_field_inst join medina_access on crm_custom_field_inst.access_id =medina_access.id and crm_custom_field_inst.access_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='access_'||crm_custom_field_inst.access_id) where access_id is not null;
            update medina_access set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='access_'||medina_access.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'charge_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct CAT_CHARGE_TEMPLATE.id as cfi_ent_id, CAT_CHARGE_TEMPLATE.provider_id as cfi_ent_provider_id from crm_custom_field_inst join CAT_CHARGE_TEMPLATE on crm_custom_field_inst.charge_template_id =CAT_CHARGE_TEMPLATE.id and crm_custom_field_inst.charge_template_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='charge_'||crm_custom_field_inst.charge_template_id) where charge_template_id is not null;
            update CAT_CHARGE_TEMPLATE set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='charge_'||CAT_CHARGE_TEMPLATE.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'offer_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct CAT_OFFER_TEMPLATE.id as cfi_ent_id, CAT_OFFER_TEMPLATE.provider_id as cfi_ent_provider_id from crm_custom_field_inst join CAT_OFFER_TEMPLATE on crm_custom_field_inst.offer_template_id =CAT_OFFER_TEMPLATE.id and crm_custom_field_inst.offer_template_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='offer_'||crm_custom_field_inst.offer_template_id) where offer_template_id is not null;
            update CAT_OFFER_TEMPLATE set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='offer_'||CAT_OFFER_TEMPLATE.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'service_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct CAT_SERVICE_TEMPLATE.id as cfi_ent_id, CAT_SERVICE_TEMPLATE.provider_id as cfi_ent_provider_id from crm_custom_field_inst join CAT_SERVICE_TEMPLATE on crm_custom_field_inst.service_template_id =CAT_SERVICE_TEMPLATE.id and crm_custom_field_inst.service_template_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='service_'||crm_custom_field_inst.service_template_id) where service_template_id is not null;
            update CAT_SERVICE_TEMPLATE set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='service_'||CAT_SERVICE_TEMPLATE.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'subs_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct BILLING_SUBSCRIPTION.id as cfi_ent_id, BILLING_SUBSCRIPTION.provider_id as cfi_ent_provider_id from crm_custom_field_inst join BILLING_SUBSCRIPTION on crm_custom_field_inst.subscription_id =BILLING_SUBSCRIPTION.id and crm_custom_field_inst.subscription_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='subs_'||crm_custom_field_inst.subscription_id) where subscription_id is not null;
            update BILLING_SUBSCRIPTION set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='subs_'||BILLING_SUBSCRIPTION.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'job_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct MEVEO_JOB_INSTANCE.id as cfi_ent_id, MEVEO_JOB_INSTANCE.provider_id as cfi_ent_provider_id from crm_custom_field_inst join MEVEO_JOB_INSTANCE on crm_custom_field_inst.job_instance_id =MEVEO_JOB_INSTANCE.id and crm_custom_field_inst.job_instance_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='job_'||crm_custom_field_inst.job_instance_id) where job_instance_id is not null;
            update MEVEO_JOB_INSTANCE set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='job_'||MEVEO_JOB_INSTANCE.id);
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'seller_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct CRM_SELLER.id as cfi_ent_id, CRM_SELLER.provider_id as cfi_ent_provider_id from crm_custom_field_inst join CRM_SELLER on crm_custom_field_inst.seller_id =CRM_SELLER.id and crm_custom_field_inst.seller_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='seller_'||crm_custom_field_inst.seller_id) where seller_id is not null;
            update CRM_SELLER set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='seller_'||CRM_SELLER.id);        
        </sql>
        <sql>
            insert into CRM_CUSTOM_FIELD_FIELDS (id, version, uuid, provider_id) select nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ'), 0, 'account_'||cfi_ent_id, cfi_ent_provider_id from 
              (select distinct ACCOUNT_ENTITY.id as cfi_ent_id, ACCOUNT_ENTITY.provider_id as cfi_ent_provider_id from crm_custom_field_inst join ACCOUNT_ENTITY on crm_custom_field_inst.account_id =ACCOUNT_ENTITY.id and crm_custom_field_inst.account_id is not null) as sql_one;
            update crm_custom_field_inst set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='account_'||crm_custom_field_inst.account_id) where account_id is not null;
            update ACCOUNT_ENTITY set cff_id = (select id from CRM_CUSTOM_FIELD_FIELDS where uuid='account_'||ACCOUNT_ENTITY.id);
        </sql>
        
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_INST" columnName="CFF_ID"/>
        
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="provider_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="access_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="charge_template_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="offer_template_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="service_template_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="subscription_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="job_instance_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="seller_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="account_id"/>
                
        <addColumn tableName="CRM_CUSTOM_FIELD_TMPL">
            <column name="APPLIES_TO" type="VARCHAR(100)"/>
        </addColumn>
        
        <sql>
            update CRM_CUSTOM_FIELD_TMPL set applies_to = account_type where account_type&lt;&gt; 'TIMER';
            update CRM_CUSTOM_FIELD_TMPL set applies_to = 'JOB_'|| SUBSTR(code, 0, strpos(code, '_')) where account_type= 'TIMER';
            update CRM_CUSTOM_FIELD_TMPL set code = 'nbRuns' where right(code,7)='_nbRuns' and account_type= 'TIMER';
            update CRM_CUSTOM_FIELD_TMPL set code = 'waitingMillis' where right(code,14)='_waitingMillis' and account_type= 'TIMER';        
        </sql>
        
        <sql>
            update CRM_CUSTOM_FIELD_TMPL set storage_type='SINGLE' where storage_type is null;
        </sql>
        
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL" columnName="APPLIES_TO"/>
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL" columnName="field_type"/>
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL" columnName="storage_type"/>
        
        <dropColumn tableName="CRM_CUSTOM_FIELD_TMPL" columnName="account_type"/>
        
    </changeSet> 
    
    <changeSet id="1201-20151102" author="Mbarek">
		<addUniqueConstraint columnNames="code,applies_to,provider_id" constraintName="uk_abfci88fr16lqf19cf961b08d" deferrable="false" disabled="false"
            initiallyDeferred="false" tableName="crm_custom_field_tmpl" />
	</changeSet>          

	<changeSet author="EdwardLegaspi" id="#1147_20151009">
		<addColumn tableName="crm_provider">
			<column name="credit_note_prefix" type="VARCHAR(255)" />
			<column name="current_credit_note_nb" type="BIGINT" />
		</addColumn>
		<addColumn tableName="crm_seller">
			<column name="credit_note_prefix" type="VARCHAR(255)" />
			<column name="current_credit_note_nb" type="BIGINT" />
		</addColumn>
	</changeSet>

	<changeSet id="#1138_20151009" author="EdwardLegaspi">
		<addColumn tableName="crm_provider">
			<column name="credit_note_sequence_size" type="INT4" />
		</addColumn>
		<addColumn tableName="crm_seller">
			<column name="credit_note_sequence_size" type="INT4" />
		</addColumn>

		<sql>UPDATE crm_provider SET credit_note_sequence_size=9;</sql>
	</changeSet>

	<changeSet id="#1167_20151015" author="EdwardLegaspi">
		<addColumn tableName="crm_provider">
			<column name="invoice_adjustment_prefix" type="VARCHAR(255)" />
			<column name="current_invoice_adjustment_nb" type="BIGINT" />
			<column name="invoice_adjustment_sequence_size" type="INT4" />
		</addColumn>
		<addColumn tableName="crm_seller">
			<column name="invoice_adjustment_prefix" type="VARCHAR(255)" />
			<column name="current_invoice_adjustment_nb" type="BIGINT" />
			<column name="invoice_adjustment_sequence_size" type="INT4" />
		</addColumn>

		<addColumn tableName="billing_invoice">
			<column name="detailed_invoice" type="boolean" defaultValue="true" />
			<column name="invoice_id" type="BIGINT" />
		</addColumn>

		<addForeignKeyConstraint constraintName="fk_billing_invoice_adjusted_invoice"
			referencedTableName="billing_invoice" baseColumnNames="invoice_id"
			baseTableName="billing_invoice" referencedColumnNames="id" />

		<sql>UPDATE billing_invoice SET invoice_type='COMMERCIAL'</sql>
	</changeSet>

	<changeSet id="#1170_20151020" author="EdwardLegaspi">
		<addColumn tableName="billing_invoice_configuration">
			<column name="display_detail" type="BOOL" defaultValueBoolean="true"></column>
		</addColumn>
	</changeSet>

	<changeSet id="#1184_20151022" author="EdwardLegaspi">
		<addColumn tableName="billing_rated_transaction">
			<column name="adjusted_rated_tx" type="BIGINT" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_billing_rated_transaction_rated_transaction"
			referencedTableName="billing_rated_transaction" baseColumnNames="adjusted_rated_tx"
			baseTableName="billing_rated_transaction" referencedColumnNames="id" />		
	</changeSet>
	
	<changeSet id="#1134-20151026" author="Mbarek">
		<addColumn tableName="crm_provider"> 
			<column name="INVOICE_SEQUENCE_SIZE" type="INT4" defaultValue="9" />
		</addColumn>
		<addColumn tableName="crm_seller"> 
			<column name="INVOICE_SEQUENCE_SIZE" type="INT4" defaultValue="9" />
		</addColumn>
	</changeSet>

    <changeSet id="#1101_20151022" author="AndriusKarpavicius">
    
        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="crm_custom_field_fields" constraintName="fk_crm_custom_field_fields_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
            
    </changeSet>
    
    <changeSet id="#1102_20151023" author="AndriusKarpavicius">
        <createSequence sequenceName="CUST_CET_SEQ"/>
        
        <createTable tableName="CUST_CET">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
            <column name="disabled" type="BOOL">
                <constraints nullable="false" />
            </column>
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="description" type="VARCHAR(100)" />
            <column name="code" type="VARCHAR(50)" />
            <column name="provider_id" type="BIGINT" />
            <column name="creator_id" type="BIGINT" />
            <column name="updater_id" type="BIGINT" />
        </createTable>
    
        <addPrimaryKey columnNames="id" constraintName="cust_cet_pkey"
            tableName="cust_cet" />

        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="cust_cet" constraintName="fk_cust_cet_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
        
        <addForeignKeyConstraint baseColumnNames="creator_id"
            baseTableName="cust_cet" constraintName="fk_creator_cust_cet_adm_user"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
        
        <addForeignKeyConstraint baseColumnNames="updater_id"
            baseTableName="cust_cet" constraintName="fk_updater_cust_cet_adm_user"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />        
    
    </changeSet>
    
    <changeSet id="#1102_20151030" author="AndriusKarpavicius">
        <addColumn tableName="CUST_CET">
            <column name="ACCESS_PERMISSION" type="VARCHAR(100)"/>        
        </addColumn>
        
        <addColumn tableName="CRM_CUSTOM_FIELD_TMPL">
            <column name="GUI_POSITION" type="VARCHAR(100)"/>
        </addColumn>
    </changeSet>
    
     <changeSet id="2037_20151105" author="Mbarek">
     	<modifyDataType columnName="FILTER_PARAM_1" newDataType="varchar(255)"   tableName="CAT_USAGE_CHARGE_TEMPLATE"/>
     	<modifyDataType columnName="FILTER_PARAM_2" newDataType="varchar(255)"   tableName="CAT_USAGE_CHARGE_TEMPLATE"/>
     	<modifyDataType columnName="FILTER_PARAM_3" newDataType="varchar(255)"   tableName="CAT_USAGE_CHARGE_TEMPLATE"/>
     	<modifyDataType columnName="FILTER_PARAM_4" newDataType="varchar(255)"   tableName="CAT_USAGE_CHARGE_TEMPLATE"/>
     </changeSet>
     
     <changeSet author="1187_20151102" id="Mbarek">
		<createTable tableName="adm_script_notification">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey columnNames="id"
			constraintName="adm_script_notification_pkey" tableName="adm_script_notification" />
		<addForeignKeyConstraint baseColumnNames="id"
			baseTableName="adm_script_notification" constraintName="fk_n1n2i3ht998wlegdshme8gyfd"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_notification" />

		<!--migration notifications -->
		<sql splitStatements="false">
			create or replace function scriptNotification() returns void as
			$body$
			declare
			cursorNotif cursor for
			select * from adm_notification where id not in(
			SELECT id FROM adm_notif_webhooks
			UNION
			SELECT id FROM adm_notif_email
			UNION
			SELECT id FROM adm_notif_job
			UNION
			SELECT id FROM adm_notif_history
			);
			notifRecord record;
			begin
			open cursorNotif;
			loop
			fetch cursorNotif into notifRecord;
			exit when not found;
			insert into adm_script_notification(id) values(notifRecord.id);
			end loop;
			close cursorNotif;
			end;
			$body$
			language plpgsql volatile;
			<!--execute function -->
			select scriptNotification();
		</sql>
	</changeSet>
    
    <changeSet id="#1102_20151105" author="AndriusKarpavicius">
        <createSequence sequenceName="CUST_CEI_SEQ"/>
        
        <createTable tableName="CUST_CEI">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
            <column name="disabled" type="BOOL">
                <constraints nullable="false" />
            </column>
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="description" type="VARCHAR(100)" />
            <column name="code" type="VARCHAR(50)" />
            <column name="provider_id" type="BIGINT" />
            <column name="creator_id" type="BIGINT" />
            <column name="updater_id" type="BIGINT" />
            <column name="cet_code" type="VARCHAR(50)" />
            <column name="CFF_ID" type="BIGINT"/>
        </createTable>    
        
        <addPrimaryKey columnNames="id" constraintName="crm_cust_cei_pkey" tableName="CUST_CEI" />
                    
        <addUniqueConstraint columnNames="code,cet_code,provider_id" constraintName="uk_cust_cei" deferrable="false" disabled="false"
                    initiallyDeferred="false" tableName="CUST_CEI" />

        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="CUST_CEI" constraintName="fk_cust_cei_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
            
        <addForeignKeyConstraint constraintName="fk_cust_cei_cff_id"
            referencedTableName="CRM_CUSTOM_FIELD_FIELDS" baseColumnNames="CFF_ID"
            baseTableName="CUST_CEI" referencedColumnNames="id" />
            
     </changeSet>
     
	<changeSet id="#1102_20151107" author="AndriusKarpavicius">
        <addColumn tableName="CUST_CET">
            <column name="name" type="VARCHAR(100)"/>        
        </addColumn>
        
        <dropColumn tableName="CUST_CET" columnName="ACCESS_PERMISSION"/>
        <addColumn tableName="CUST_CET">
            <column name="permission_id" type="BIGINT"/>
        </addColumn>
        
        <addForeignKeyConstraint baseColumnNames="permission_id"
            baseTableName="CUST_CET" constraintName="fk_cust_cet_adm_permission"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_permission" />
    </changeSet>
    
      <changeSet author="TyshanShi" id="#1103_20151108">
		<createTable tableName="meveo_module">
		<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="disabled" type="BOOL">
				<constraints nullable="false" />
			</column>
			<column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
			<column name="provider_id" type="BIGINT" />
			<column name="creator_id" type="BIGINT" />
			<column name="updater_id" type="BIGINT" />
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(100)" />
			<column name="module_status" type="VARCHAR(10)" />
		</createTable>
		<addPrimaryKey columnNames="id" constraintName="meveo_module_pkey"
			tableName="meveo_module" />
		<addForeignKeyConstraint baseColumnNames="provider_id"
			baseTableName="meveo_module" constraintName="fk_meveo_module_crm_provider"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
		<addForeignKeyConstraint baseColumnNames="creator_id"
			baseTableName="meveo_module" constraintName="fk_creator_meveo_module_adm_user"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		<addForeignKeyConstraint baseColumnNames="updater_id"
			baseTableName="meveo_module" constraintName="fk_updater_meveo_module_adm_user"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		<createSequence sequenceName="meveo_module_seq" startValue="1"/>
	</changeSet>
	<changeSet author="TyshanShi" id="#1103_20151108_1">
		<createTable tableName="meveo_module_item">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="provider_id" type="BIGINT" />
			<column name="module_id" type="BIGINT" />
			<column name="item_type" type="VARCHAR(20)" />
			<column name="item_code" type="VARCHAR(100)" />
			<column name="item_id" type="BIGINT" />
			<column name="clazz_name" type="VARCHAR(255)" />
			<column name="entity_name" type="VARCHAR(255)" />
		</createTable>
		<addPrimaryKey columnNames="id" constraintName="meveo_module_item_pkey"
			tableName="meveo_module_item" />
		<addForeignKeyConstraint baseColumnNames="provider_id"
			baseTableName="meveo_module_item" constraintName="fk_meveo_module_item_crm_provider"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
		<addForeignKeyConstraint baseColumnNames="module_id"
			baseTableName="meveo_module_item" constraintName="fk_meveo_module_item_meveo_module"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_module" />
		<createSequence sequenceName="meveo_module_item_seq" startValue="1"/>
	</changeSet>
    <changeSet author="anasseh" id="#1221_20151109">
        <createSequence sequenceName="FTP_IMPORTED_FILE_SEQ" startValue="1" />
    </changeSet>
    
    <changeSet author="anasseh" id="#1221_20151109_1">
        <createTable tableName="FTP_IMPORTED_FILE">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
            <column name="disabled" type="BOOL">
                <constraints nullable="false" />
            </column>
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="provider_id" type="BIGINT" />
            <column name="creator_id" type="BIGINT" />
            <column name="updater_id" type="BIGINT" />
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(100)" />
            <column name="URI" type="VARCHAR(2000)">
                <constraints nullable="false" />
            </column>
            <column name="SIZE" type="BIGINT"/>            
            <column name="IMPORT_DATE" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="LAST_MODIFICATION" type="TIMESTAMP WITHOUT TIME ZONE"/>

        </createTable>
        <addPrimaryKey columnNames="id" constraintName="Ftp_Imported_File_pkey"
            tableName="FTP_IMPORTED_FILE" />
        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="FTP_IMPORTED_FILE" constraintName="fk_Ftp_Imported_File_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
        <addForeignKeyConstraint baseColumnNames="creator_id"
            baseTableName="FTP_IMPORTED_FILE" constraintName="fk_creator_Ftp_Imported_File_adm_user"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />

        <addForeignKeyConstraint baseColumnNames="updater_id"
            baseTableName="FTP_IMPORTED_FILE" constraintName="fk_updater_Ftp_Imported_File_adm_user"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
    </changeSet>		
	<changeSet author="TyshanShi" id="#1103_20151113_1">
        <delete tableName="meveo_module_item"/>
		<dropColumn tableName="meveo_module" columnName="module_status"/>
		<dropColumn tableName="meveo_module_item" columnName="clazz_name"/>
		<dropColumn tableName="meveo_module_item" columnName="entity_name"/>
		<dropColumn tableName="meveo_module_item" columnName="item_id"/>
		<dropColumn tableName="meveo_module_item" columnName="item_type"/>
		<dropColumn tableName="meveo_module_item" columnName="item_code"/>
		<addColumn tableName="meveo_module_item">
			<column name="applies_to" type="VARCHAR(100)"/>
			<column name="item_type" type="VARCHAR(20)">
				<constraints nullable="false"/>
			</column>
			<column name="item_code" type="VARCHAR(60)">
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>
    <changeSet id="#1102_20151117" author="AndriusKarpavicius">
        <dropColumn tableName="CUST_CET" columnName="permission_id"/>        
    </changeSet>
    <changeSet id="#1270_20151117" author="AndriusKarpavicius">
        <createTable tableName="adm_role_role">
            <column name="role_id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="child_role_id" type="BIGINT">
                <constraints nullable="false" />
            </column>
        </createTable>
        <sql>insert into adm_role (id, version, role_name, role_description, provider_id) (select nextval('adm_role_seq'), 0, 'ModifyAllCE', 'Modify all custom entities', crm_provider.id from crm_provider) </sql>
        <sql>insert into adm_role (id, version, role_name, role_description, provider_id) (select nextval('adm_role_seq'), 0, 'ReadAllCE', 'Read all custom entities', crm_provider.id from crm_provider) </sql>    
        <sql>insert into adm_role_role (role_id, child_role_id) (select role_p.id, role_c.id from adm_role role_p join adm_role role_c on role_p.provider_id=role_c.provider_id and role_p.role_name='administrateur' and role_c.role_name='ModifyAllCE')</sql>
        <sql>insert into adm_role_role (role_id, child_role_id) (select role_p.id, role_c.id from adm_role role_p join adm_role role_c on role_p.provider_id=role_c.provider_id and role_p.role_name='ModifyAllCE' and role_c.role_name='ReadAllCE')</sql>
    </changeSet>    
	<changeSet author="TyshanShi" id="#1103_20151119">
		<addColumn tableName="meveo_module">
			<column name="module_license" type="VARCHAR(20)">
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>
    <changeSet id="#1248_20151120" author="AndriusKarpavicius">
        <addColumn tableName="CRM_CUSTOM_FIELD_TMPL">
            <column name="ALLOW_EDIT" type="BOOL" defaultValueBoolean="true">
                <constraints nullable="false" />
            </column>
            <column name="HIDE_ON_NEW" type="BOOL" defaultValueBoolean="false">
                <constraints nullable="false" />
            </column>
            <column name="MAX_VALUE" type="BIGINT" />
            <column name="MIN_VALUE" type="BIGINT" />
            <column name="REG_EXP" type="VARCHAR(80)" />
        </addColumn>
    </changeSet>
    <changeSet id="#1248_20151119" author="AndriusKarpavicius">
        <addColumn tableName="CRM_CUSTOM_FIELD_TMPL">
            <column name="CACHE_VALUE" type="BOOL" defaultValueBoolean="true">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>    
    <changeSet id="#1248_20151122" author="AndriusKarpavicius">
        <sql>update CRM_CUSTOM_FIELD_TMPL set max_value=50 where max_value is null and field_type='STRING'</sql>
    </changeSet>
    
    <changeSet id="#1186_20151123" author="ManuLiwanag">
        <addColumn tableName="ADM_NOTIF_WEBHOOKS">
            <column name="BODY_EL" type="VARCHAR(255)"/>        
        </addColumn>
    </changeSet>
    
   <changeSet id="#1289-20151124" author="Mbarek">
    <modifyDataType columnName="FILTER_EXPRESSION" newDataType="VARCHAR(2000)"
			tableName="CAT_USAGE_CHARGE_TEMPLATE" />
	<modifyDataType columnName="CEILING_EXPRESSION_EL" newDataType="VARCHAR(2000)"
			tableName="CAT_COUNTER_TEMPLATE" />
	<modifyDataType columnName="EXPRESSION_EL" newDataType="VARCHAR(2000)"
			tableName="CAT_DISCOUNT_PLAN_ITEM" />
	<modifyDataType columnName="SUBSCRIPTION_EL" newDataType="VARCHAR(2000)"
			tableName="CAT_TRIGGERED_EDR" />	
	<modifyDataType columnName="CONDITION_EL" newDataType="VARCHAR(2000)"
			tableName="CAT_TRIGGERED_EDR" />
	<modifyDataType columnName="QUANTITY_EL" newDataType="VARCHAR(2000)"
			tableName="CAT_TRIGGERED_EDR" />
	<modifyDataType columnName="PARAM_1_EL" newDataType="VARCHAR(2000)"
			tableName="CAT_TRIGGERED_EDR" />
	<modifyDataType columnName="PARAM_2_EL" newDataType="VARCHAR(2000)"
			tableName="CAT_TRIGGERED_EDR" />
	<modifyDataType columnName="PARAM_3_EL" newDataType="VARCHAR(2000)"
			tableName="CAT_TRIGGERED_EDR" />	
	<modifyDataType columnName="PARAM_4_EL" newDataType="VARCHAR(2000)"
			tableName="CAT_TRIGGERED_EDR" />	
	<modifyDataType columnName="EMAIL_TO_EL" newDataType="VARCHAR(2000)"
			tableName="ADM_NOTIF_EMAIL" />
	<modifyDataType columnName="ID_EXPRESSION" newDataType="VARCHAR(2000)"
			tableName="ADM_NOTIF_IM" />
	<modifyDataType columnName="EVENT_EXPRESSION_FILTER" newDataType="VARCHAR(2000)"
			tableName="ADM_NOTIFICATION" />
	<modifyDataType columnName="CONDITION_EL" newDataType="VARCHAR(2000)"
			tableName="AR_ACTION_PLAN_ITEM" />
	<modifyDataType columnName="CONDITION_EL" newDataType="VARCHAR(2000)"
			tableName="AR_DUNNING_PLAN_TRANSITION" />																														
	</changeSet>

    <changeSet id="#1101_20151203" author="AndriusKarpavicius">
        <addColumn tableName="CRM_CUSTOM_FIELD_INST">
            <column name="APPLIES_TO_UUID" type="VARCHAR(50)"/>
            <column name="PRIORITY" type="INT4" defaultValue="0" />
            <column name="period_end_date" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="period_start_date" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="provider_id" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="MEDINA_ACCESS">
            <column name="UUID" type="VARCHAR(50)"/>
        </addColumn>        
        <addColumn tableName="CRM_PROVIDER">
            <column name="UUID" type="VARCHAR(50)"/>
        </addColumn>
        <addColumn tableName="ACCOUNT_ENTITY">
            <column name="UUID" type="VARCHAR(50)"/>
        </addColumn>
        <addColumn tableName="CAT_CHARGE_TEMPLATE">
            <column name="UUID" type="VARCHAR(50)"/>
        </addColumn>
        <addColumn tableName="MEVEO_JOB_INSTANCE">
            <column name="UUID" type="VARCHAR(50)"/>
        </addColumn>
        <addColumn tableName="CAT_OFFER_TEMPLATE">
            <column name="UUID" type="VARCHAR(50)"/>
        </addColumn>
        <addColumn tableName="CRM_SELLER">
            <column name="UUID" type="VARCHAR(50)"/>
        </addColumn>
        <addColumn tableName="CAT_SERVICE_TEMPLATE">
            <column name="UUID" type="VARCHAR(50)"/>
        </addColumn>
        <addColumn tableName="BILLING_SUBSCRIPTION">
            <column name="UUID" type="VARCHAR(50)"/>
        </addColumn>    
        <addColumn tableName="CUST_CEI">
            <column name="UUID" type="VARCHAR(50)"/>
        </addColumn>    
        
    
        <sql>update CRM_CUSTOM_FIELD_INST set APPLIES_TO_UUID =cff_id</sql>
        <sql>update CRM_CUSTOM_FIELD_INST set provider_id=(select provider_id from crm_custom_field_fields where crm_custom_field_fields.id =CRM_CUSTOM_FIELD_INST.cff_id)</sql>
        <sql>update MEDINA_ACCESS set UUID =cff_id where cff_id is not null</sql>
        <sql>update CRM_PROVIDER set UUID =cff_id where cff_id is not null</sql>
        <sql>update ACCOUNT_ENTITY set UUID =cff_id where cff_id is not null</sql>
        <sql>update CAT_CHARGE_TEMPLATE set UUID =cff_id where cff_id is not null</sql>
        <sql>update MEVEO_JOB_INSTANCE set UUID =cff_id where cff_id is not null</sql>
        <sql>update CAT_OFFER_TEMPLATE set UUID =cff_id where cff_id is not null</sql>
        <sql>update CRM_SELLER set UUID =cff_id where cff_id is not null</sql>
        <sql>update CAT_SERVICE_TEMPLATE set UUID =cff_id where cff_id is not null</sql>
        <sql>update BILLING_SUBSCRIPTION set UUID =cff_id where cff_id is not null</sql>
        <sql>update CUST_CEI set UUID =cff_id where cff_id is not null</sql>       
        
        <sql>update MEDINA_ACCESS set UUID =nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ') where uuid is null</sql>
        <sql>update CRM_PROVIDER set UUID =nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ') where uuid is null</sql>
        <sql>update ACCOUNT_ENTITY set UUID =nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ') where uuid is null</sql>
        <sql>update CAT_CHARGE_TEMPLATE set UUID =nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ') where uuid is null</sql>
        <sql>update MEVEO_JOB_INSTANCE set UUID =nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ') where uuid is null</sql>
        <sql>update CAT_OFFER_TEMPLATE set UUID =nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ') where uuid is null</sql>
        <sql>update CRM_SELLER set UUID =nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ') where uuid is null</sql>
        <sql>update CAT_SERVICE_TEMPLATE set UUID =nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ') where uuid is null</sql>
        <sql>update BILLING_SUBSCRIPTION set UUID =nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ') where uuid is null</sql>
        <sql>update CUST_CEI set UUID =nextval('CRM_CUSTOM_FIELD_FIELDS_SEQ') where uuid is null</sql>  
        
    
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="CFF_ID"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="DESCRIPTION"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="versionable"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="calendar_id"/>
        <dropColumn tableName="CRM_CUSTOM_FIELD_INST" columnName="trigger_end_period_event"/>        
        <dropColumn tableName="MEDINA_ACCESS" columnName="CFF_ID"/>
        <dropColumn tableName="CRM_PROVIDER" columnName="CFF_ID"/>
        <dropColumn tableName="ACCOUNT_ENTITY" columnName="CFF_ID"/>
        <dropColumn tableName="CAT_CHARGE_TEMPLATE" columnName="CFF_ID"/>
        <dropColumn tableName="MEVEO_JOB_INSTANCE" columnName="CFF_ID"/>
        <dropColumn tableName="CAT_OFFER_TEMPLATE" columnName="CFF_ID"/>
        <dropColumn tableName="CRM_SELLER" columnName="CFF_ID"/>
        <dropColumn tableName="CAT_SERVICE_TEMPLATE" columnName="CFF_ID"/>
        <dropColumn tableName="BILLING_SUBSCRIPTION" columnName="CFF_ID"/>
        <dropColumn tableName="CUST_CEI" columnName="CFF_ID"/>
    
        <sql>insert into CRM_CUSTOM_FIELD_INST (id, version, provider_id, APPLIES_TO_UUID, disabled, created, updated, code, date_value, double_value, long_value, string_value, creator_id, updater_id, serialized_value, priority, period_end_date, period_start_date)
            (select nextval('crm_custom_field_inst_seq'), 0, cfi.provider_id, cfi.APPLIES_TO_UUID, cfi.disabled, cfi.created, cfi.updated, cfi.code, cfp.date_value, cfp.double_value, cfp.long_value, cfp.string_value, cfi.creator_id, cfi.updater_id, cfp.serialized_value, cfp.priority, cfp.period_end_date, cfp.period_start_date from crm_custom_field_inst cfi join crm_custom_field_period cfp on cfi.id=cfp.cf_instance_id)
        </sql>
    
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_INST" columnName="APPLIES_TO_UUID"/>
        <addNotNullConstraint tableName="MEDINA_ACCESS" columnName="UUID"/>
        <addNotNullConstraint tableName="CRM_PROVIDER" columnName="UUID"/>
        <addNotNullConstraint tableName="ACCOUNT_ENTITY" columnName="UUID"/>
        <addNotNullConstraint tableName="CAT_CHARGE_TEMPLATE" columnName="UUID"/>
        <addNotNullConstraint tableName="MEVEO_JOB_INSTANCE" columnName="UUID"/>
        <addNotNullConstraint tableName="CAT_OFFER_TEMPLATE" columnName="UUID"/>
        <addNotNullConstraint tableName="CRM_SELLER" columnName="UUID"/>
        <addNotNullConstraint tableName="CAT_SERVICE_TEMPLATE" columnName="UUID"/>
        <addNotNullConstraint tableName="BILLING_SUBSCRIPTION" columnName="UUID"/>
        <addNotNullConstraint tableName="CUST_CEI" columnName="UUID"/>
    
        <dropForeignKeyConstraint baseTableName="CRM_CUSTOM_FIELD_PERIOD" constraintName="fk_CFP_CFI"/>
        <sql>delete from CRM_CUSTOM_FIELD_INST where id in (select cf_instance_id from crm_custom_field_period)</sql>
        
        <dropTable tableName="CRM_CUSTOM_FIELD_PERIOD"/>
        <dropTable tableName="crm_custom_field_fields"/>
        <dropSequence sequenceName="crm_custom_field_period_seq"/>
        <dropSequence sequenceName="CRM_CUSTOM_FIELD_FIELDS_SEQ"/>
            
        <addUniqueConstraint columnNames="APPLIES_TO_UUID, code, period_start_date, period_end_date" tableName="crm_custom_field_inst" constraintName="uk_crm_custom_field_inst" />
 
        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="CRM_CUSTOM_FIELD_INST" constraintName="fk_crm_custom_field_inst_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
        
    </changeSet>            
    
     
    <changeSet id="#1101_20151207-1" author="AndriusKarpavicius">
        <sql>
            update CAT_COUNTER_TEMPLATE set CEILING_EXPRESSION_EL=replace(CEILING_EXPRESSION_EL,'.customFields[','.getCFValue(')  where CEILING_EXPRESSION_EL is not null and CEILING_EXPRESSION_EL not like '%mv:%';
            update CAT_COUNTER_TEMPLATE set CEILING_EXPRESSION_EL=replace(CEILING_EXPRESSION_EL,'].cfValue',')')  where CEILING_EXPRESSION_EL is not null and CEILING_EXPRESSION_EL not like '%mv:%';
            update CAT_DISCOUNT_PLAN_ITEM set EXPRESSION_EL=replace(EXPRESSION_EL,'.customFields[','.getCFValue(')  where EXPRESSION_EL is not null and EXPRESSION_EL not like '%mv:%';
            update CAT_DISCOUNT_PLAN_ITEM set EXPRESSION_EL=replace(EXPRESSION_EL,'].cfValue',')')  where EXPRESSION_EL is not null and EXPRESSION_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set SUBSCRIPTION_EL=replace(SUBSCRIPTION_EL,'.customFields[','.getCFValue(')  where SUBSCRIPTION_EL is not null and SUBSCRIPTION_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set SUBSCRIPTION_EL=replace(SUBSCRIPTION_EL,'].cfValue',')')  where SUBSCRIPTION_EL is not null and SUBSCRIPTION_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set CONDITION_EL=replace(CONDITION_EL,'.customFields[','.getCFValue(')  where CONDITION_EL is not null and CONDITION_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set CONDITION_EL=replace(CONDITION_EL,'].cfValue',')')  where CONDITION_EL is not null and CONDITION_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set QUANTITY_EL=replace(QUANTITY_EL,'.customFields[','.getCFValue(')  where QUANTITY_EL is not null and QUANTITY_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set QUANTITY_EL=replace(QUANTITY_EL,'].cfValue',')')  where QUANTITY_EL is not null and QUANTITY_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_1_EL=replace(PARAM_1_EL,'.customFields[','.getCFValue(')  where PARAM_1_EL is not null and PARAM_1_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_1_EL=replace(PARAM_1_EL,'].cfValue',')')  where PARAM_1_EL is not null and PARAM_1_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_2_EL=replace(PARAM_2_EL,'.customFields[','.getCFValue(')  where PARAM_2_EL is not null and PARAM_2_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_2_EL=replace(PARAM_2_EL,'].cfValue',')')  where PARAM_2_EL is not null and PARAM_2_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_3_EL=replace(PARAM_3_EL,'.customFields[','.getCFValue(')  where PARAM_3_EL is not null and PARAM_3_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_3_EL=replace(PARAM_3_EL,'].cfValue',')')  where PARAM_3_EL is not null and PARAM_3_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_4_EL=replace(PARAM_4_EL,'.customFields[','.getCFValue(')  where PARAM_4_EL is not null and PARAM_4_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_4_EL=replace(PARAM_4_EL,'].cfValue',')')  where PARAM_4_EL is not null and PARAM_4_EL not like '%mv:%';
            update MEVEO_NATIVE_FILTER_CONDITION set EL=replace(EL,'.customFields[','.getCFValue(')  where EL is not null and EL not like '%mv:%';
            update MEVEO_NATIVE_FILTER_CONDITION set EL=replace(EL,'].cfValue',')')  where EL is not null and EL not like '%mv:%';
            update ADM_NOTIF_EMAIL set EMAIL_TO_EL=replace(EMAIL_TO_EL,'.customFields[','.getCFValue(')  where EMAIL_TO_EL is not null and EMAIL_TO_EL not like '%mv:%';
            update ADM_NOTIF_EMAIL set EMAIL_TO_EL=replace(EMAIL_TO_EL,'].cfValue',')')  where EMAIL_TO_EL is not null and EMAIL_TO_EL not like '%mv:%';
            update ADM_NOTIF_WEBHOOKS set BODY_EL=replace(BODY_EL,'.customFields[','.getCFValue(')  where BODY_EL is not null and BODY_EL not like '%mv:%';
            update ADM_NOTIF_WEBHOOKS set BODY_EL=replace(BODY_EL,'].cfValue',')')  where BODY_EL is not null and BODY_EL not like '%mv:%';
            update ADM_NOTIF_IM set ID_EXPRESSION=replace(ID_EXPRESSION,'.customFields[','.getCFValue(')  where ID_EXPRESSION is not null and ID_EXPRESSION not like '%mv:%';
            update ADM_NOTIF_IM set ID_EXPRESSION=replace(ID_EXPRESSION,'].cfValue',')')  where ID_EXPRESSION is not null and ID_EXPRESSION not like '%mv:%';
            update ADM_NOTIFICATION set EVENT_EXPRESSION_FILTER=replace(EVENT_EXPRESSION_FILTER,'.customFields[','.getCFValue(')  where EVENT_EXPRESSION_FILTER is not null and EVENT_EXPRESSION_FILTER not like '%mv:%';
            update ADM_NOTIFICATION set EVENT_EXPRESSION_FILTER=replace(EVENT_EXPRESSION_FILTER,'].cfValue',')')  where EVENT_EXPRESSION_FILTER is not null and EVENT_EXPRESSION_FILTER not like '%mv:%';
            update AR_ACTION_PLAN_ITEM set CONDITION_EL=replace(CONDITION_EL,'.customFields[','.getCFValue(')  where CONDITION_EL is not null and CONDITION_EL not like '%mv:%';
            update AR_ACTION_PLAN_ITEM set CONDITION_EL=replace(CONDITION_EL,'].cfValue',')')  where CONDITION_EL is not null and CONDITION_EL not like '%mv:%';
            update AR_DUNNING_PLAN_TRANSITION set CONDITION_EL=replace(CONDITION_EL,'.customFields[','.getCFValue(')  where CONDITION_EL is not null and CONDITION_EL not like '%mv:%';
            update AR_DUNNING_PLAN_TRANSITION set CONDITION_EL=replace(CONDITION_EL,'].cfValue',')')  where CONDITION_EL is not null and CONDITION_EL not like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set CRITERIA_EL=replace(CRITERIA_EL,'.customFields[','.getCFValue(')  where CRITERIA_EL is not null and CRITERIA_EL not like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set CRITERIA_EL=replace(CRITERIA_EL,'].cfValue',')')  where CRITERIA_EL is not null and CRITERIA_EL not like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set AMOUNT_WITHOUT_TAX_EL=replace(AMOUNT_WITHOUT_TAX_EL,'.customFields[','.getCFValue(')  where AMOUNT_WITHOUT_TAX_EL is not null and AMOUNT_WITHOUT_TAX_EL not like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set AMOUNT_WITHOUT_TAX_EL=replace(AMOUNT_WITHOUT_TAX_EL,'].cfValue',')')  where AMOUNT_WITHOUT_TAX_EL is not null and AMOUNT_WITHOUT_TAX_EL not like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set AMOUNT_WITH_TAX_EL=replace(AMOUNT_WITH_TAX_EL,'.customFields[','.getCFValue(')  where AMOUNT_WITH_TAX_EL is not null and AMOUNT_WITH_TAX_EL not like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set AMOUNT_WITH_TAX_EL=replace(AMOUNT_WITH_TAX_EL,'].cfValue',')')  where AMOUNT_WITH_TAX_EL is not null and AMOUNT_WITH_TAX_EL not like '%mv:%';
            update BILLING_INV_SUB_CAT_COUNTRY set FILTER_EL=replace(FILTER_EL,'.customFields[','.getCFValue(')  where FILTER_EL is not null and FILTER_EL not like '%mv:%';
            update BILLING_INV_SUB_CAT_COUNTRY set FILTER_EL=replace(FILTER_EL,'].cfValue',')')  where FILTER_EL is not null and FILTER_EL not like '%mv:%';

        
            update CAT_COUNTER_TEMPLATE set CEILING_EXPRESSION_EL= regexp_replace(CEILING_EXPRESSION_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where CEILING_EXPRESSION_EL is not null and CEILING_EXPRESSION_EL not like '%mv:%';
            update CAT_DISCOUNT_PLAN_ITEM set EXPRESSION_EL= regexp_replace(EXPRESSION_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where EXPRESSION_EL is not null and EXPRESSION_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set SUBSCRIPTION_EL= regexp_replace(SUBSCRIPTION_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where SUBSCRIPTION_EL is not null and SUBSCRIPTION_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set CONDITION_EL= regexp_replace(CONDITION_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where CONDITION_EL is not null and CONDITION_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set QUANTITY_EL= regexp_replace(QUANTITY_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where QUANTITY_EL is not null and QUANTITY_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_1_EL= regexp_replace(PARAM_1_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where PARAM_1_EL is not null and PARAM_1_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_2_EL= regexp_replace(PARAM_2_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where PARAM_2_EL is not null and PARAM_2_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_3_EL= regexp_replace(PARAM_3_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where PARAM_3_EL is not null and PARAM_3_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_4_EL= regexp_replace(PARAM_4_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where PARAM_4_EL is not null and PARAM_4_EL not like '%mv:%';
            update MEVEO_NATIVE_FILTER_CONDITION set EL= regexp_replace(EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where EL is not null and EL not like '%mv:%';
            update ADM_NOTIF_EMAIL set EMAIL_TO_EL= regexp_replace(EMAIL_TO_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where EMAIL_TO_EL is not null and EMAIL_TO_EL not like '%mv:%';
            update ADM_NOTIF_WEBHOOKS set BODY_EL= regexp_replace(BODY_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where BODY_EL is not null and BODY_EL not like '%mv:%';
            update ADM_NOTIF_IM set ID_EXPRESSION= regexp_replace(ID_EXPRESSION, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where ID_EXPRESSION is not null and ID_EXPRESSION not like '%mv:%';
            update ADM_NOTIFICATION set EVENT_EXPRESSION_FILTER= regexp_replace(EVENT_EXPRESSION_FILTER, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where EVENT_EXPRESSION_FILTER is not null and EVENT_EXPRESSION_FILTER not like '%mv:%'; 
            update AR_ACTION_PLAN_ITEM set CONDITION_EL= regexp_replace(CONDITION_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where CONDITION_EL is not null and CONDITION_EL not like '%mv:%';
            update AR_DUNNING_PLAN_TRANSITION set CONDITION_EL= regexp_replace(CONDITION_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where CONDITION_EL is not null and CONDITION_EL not like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set CRITERIA_EL= regexp_replace(CRITERIA_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where CRITERIA_EL is not null and CRITERIA_EL not like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set AMOUNT_WITHOUT_TAX_EL= regexp_replace(AMOUNT_WITHOUT_TAX_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where AMOUNT_WITHOUT_TAX_EL is not null and AMOUNT_WITHOUT_TAX_EL not like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set AMOUNT_WITH_TAX_EL= regexp_replace(AMOUNT_WITH_TAX_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where AMOUNT_WITH_TAX_EL is not null and AMOUNT_WITH_TAX_EL not like '%mv:%';
            update BILLING_INV_SUB_CAT_COUNTRY set FILTER_EL= regexp_replace(FILTER_EL, E'([a-z|A-Z|\.]*)\.getCFValue\\(', E'mv:getCFValue\(\\1,','g')  where FILTER_EL is not null and FILTER_EL not like '%mv:%';
   
        </sql>
    </changeSet>
    <changeSet id="#1101_20151209-1" author="AndriusKarpavicius">
        <sql>
            update CAT_COUNTER_TEMPLATE set CEILING_EXPRESSION_EL= regexp_replace(CEILING_EXPRESSION_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where CEILING_EXPRESSION_EL is not null and CEILING_EXPRESSION_EL not like '%mv:%';
            update CAT_DISCOUNT_PLAN_ITEM set EXPRESSION_EL= regexp_replace(EXPRESSION_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where EXPRESSION_EL is not null and EXPRESSION_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set SUBSCRIPTION_EL= regexp_replace(SUBSCRIPTION_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where SUBSCRIPTION_EL is not null and SUBSCRIPTION_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set CONDITION_EL= regexp_replace(CONDITION_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where CONDITION_EL is not null and CONDITION_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set QUANTITY_EL= regexp_replace(QUANTITY_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where QUANTITY_EL is not null and QUANTITY_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_1_EL= regexp_replace(PARAM_1_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where PARAM_1_EL is not null and PARAM_1_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_2_EL= regexp_replace(PARAM_2_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where PARAM_2_EL is not null and PARAM_2_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_3_EL= regexp_replace(PARAM_3_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where PARAM_3_EL is not null and PARAM_3_EL not like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_4_EL= regexp_replace(PARAM_4_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where PARAM_4_EL is not null and PARAM_4_EL not like '%mv:%';
            update MEVEO_NATIVE_FILTER_CONDITION set EL= regexp_replace(EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where EL is not null and EL not like '%mv:%';
            update ADM_NOTIF_EMAIL set EMAIL_TO_EL= regexp_replace(EMAIL_TO_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where EMAIL_TO_EL is not null and EMAIL_TO_EL not like '%mv:%';
            update ADM_NOTIF_WEBHOOKS set BODY_EL= regexp_replace(BODY_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where BODY_EL is not null and BODY_EL not like '%mv:%';
            update ADM_NOTIF_IM set ID_EXPRESSION= regexp_replace(ID_EXPRESSION, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where ID_EXPRESSION is not null and ID_EXPRESSION not like '%mv:%';
            update ADM_NOTIFICATION set EVENT_EXPRESSION_FILTER= regexp_replace(EVENT_EXPRESSION_FILTER, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where EVENT_EXPRESSION_FILTER is not null and EVENT_EXPRESSION_FILTER not like '%mv:%'; 
            update AR_ACTION_PLAN_ITEM set CONDITION_EL= regexp_replace(CONDITION_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where CONDITION_EL is not null and CONDITION_EL not like '%mv:%';
            update AR_DUNNING_PLAN_TRANSITION set CONDITION_EL= regexp_replace(CONDITION_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where CONDITION_EL is not null and CONDITION_EL not like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set CRITERIA_EL= regexp_replace(CRITERIA_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where CRITERIA_EL is not null and CRITERIA_EL not like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set AMOUNT_WITHOUT_TAX_EL= regexp_replace(AMOUNT_WITHOUT_TAX_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where AMOUNT_WITHOUT_TAX_EL is not null and AMOUNT_WITHOUT_TAX_EL not like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set AMOUNT_WITH_TAX_EL= regexp_replace(AMOUNT_WITH_TAX_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where AMOUNT_WITH_TAX_EL is not null and AMOUNT_WITH_TAX_EL not like '%mv:%';
            update BILLING_INV_SUB_CAT_COUNTRY set FILTER_EL= regexp_replace(FILTER_EL, E'([a-z|A-Z|\.]*)\.getInheritedCFValue\\(', E'mv:getInheritedCFValue\(\\1,','g')  where FILTER_EL is not null and FILTER_EL not like '%mv:%';
   
        </sql>
    </changeSet>    
    
       <changeSet id="#1320-20151210" author="Mbarek">
	    <modifyDataType columnName="PARAMETER_1" newDataType="VARCHAR(255)"
				tableName="BILLING_WALLET_OPERATION" />
		<modifyDataType columnName="PARAMETER_2" newDataType="VARCHAR(255)"
				tableName="BILLING_WALLET_OPERATION" />
		<modifyDataType columnName="PARAMETER_3" newDataType="VARCHAR(255)"
				tableName="BILLING_WALLET_OPERATION" />	
		 <modifyDataType columnName="PARAMETER_1" newDataType="VARCHAR(255)"
				tableName="BILLING_RATED_TRANSACTION" />
		<modifyDataType columnName="PARAMETER_2" newDataType="VARCHAR(255)"
				tableName="BILLING_RATED_TRANSACTION" />
		<modifyDataType columnName="PARAMETER_3" newDataType="VARCHAR(255)"
				tableName="BILLING_RATED_TRANSACTION" />																																			
		</changeSet>

	<changeSet id="#1322-20151214" author="EdwardLegaspi">
		<addColumn tableName="cat_offer_template">
			<column name="bom_code" type="VARCHAR(60)"></column>
			<column name="termination_script_instance_id" type="BIGINT"></column>
			<column name="subscription_script_instance_id" type="BIGINT"></column>
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_cat_offer_template_script_instance_termination"
			referencedTableName="meveo_script_instance" baseColumnNames="termination_script_instance_id"
			baseTableName="cat_offer_template" referencedColumnNames="id" />
		<addForeignKeyConstraint
			constraintName="fk_cat_offer_template_script_instance_subscription"
			referencedTableName="meveo_script_instance" baseColumnNames="subscription_script_instance_id"
			baseTableName="cat_offer_template" referencedColumnNames="id" />
			
		<addColumn tableName="cat_service_template">
			<column name="termination_script_instance_id" type="BIGINT"></column>
			<column name="activation_script_instance_id" type="BIGINT"></column>
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_cat_service_template_script_instance_termination"
			referencedTableName="meveo_script_instance" baseColumnNames="termination_script_instance_id"
			baseTableName="cat_service_template" referencedColumnNames="id" />
		<addForeignKeyConstraint
			constraintName="fk_cat_service_template_script_instance_activation"
			referencedTableName="meveo_script_instance" baseColumnNames="activation_script_instance_id"
			baseTableName="cat_service_template" referencedColumnNames="id" />
	
		<createTable tableName="cat_bom_entity">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="disabled" type="BOOL">
				<constraints nullable="false" />
			</column>
			<column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(100)" />
			<column name="provider_id" type="BIGINT" />
			<column name="creator_id" type="BIGINT" />
			<column name="updater_id" type="BIGINT" />
			<column name="offer_template_id" type="BIGINT" />
			<column name="script_instance_id" type="BIGINT" />
		</createTable>
		
		<addForeignKeyConstraint
			constraintName="fk_bom_entity_offer_template"
			referencedTableName="cat_offer_template" baseColumnNames="offer_template_id"
			baseTableName="cat_bom_entity" referencedColumnNames="id" />
		<addForeignKeyConstraint
			constraintName="fk_bom_entity_script_instance"
			referencedTableName="meveo_script_instance" baseColumnNames="script_instance_id"
			baseTableName="cat_bom_entity" referencedColumnNames="id" />
		<createSequence sequenceName="cat_bom_entity_seq" />
		<addUniqueConstraint columnNames="code, provider_id" constraintName="uk_bom_entity" deferrable="false" disabled="false"
            initiallyDeferred="false" tableName="cat_bom_entity" />						

	</changeSet>
	
	<changeSet id="#1362-20151218" author="Mbarek">
	    <modifyDataType columnName="MANDATE_IDENTIFICATION" newDataType="VARCHAR(256)"
				tableName="AR_CUSTOMER_ACCOUNT" /> 																																			
		</changeSet>
	<changeSet id="#1103-20151221" author="TyshanShi">
		<addUniqueConstraint columnNames="code, provider_id" constraintName="uk_meveo_module_provider" deferrable="false" disabled="false" initiallyDeferred="false"
            tableName="meveo_module" />
	</changeSet>

    <changeSet id="#1360=20151219" author="AndriusKarpavicius">
        <addColumn tableName="CRM_CUSTOM_FIELD_TMPL">
            <column name="MAPKEY_TYPE" type="varchar(20)"/>
        </addColumn>
        <sql>update CRM_CUSTOM_FIELD_TMPL set MAPKEY_TYPE='STRING' where storage_type='MAP'</sql>
    </changeSet>
    
    <changeSet id="#1113_20151228" author="AndriusKarpavicius">
        <addColumn tableName="CRM_CUSTOM_FIELD_TMPL">
            <column name="APPLICABLE_ON_EL" type="varchar(150)"/>
        </addColumn>
    </changeSet>
    
	<changeSet author="anasseh" id="#1214_20151229">
		<createTable tableName="adm_script_exec_role">
			<column name="script_instance_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="role_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addPrimaryKey columnNames="script_instance_id, role_id" constraintName="adm_script_exec_role_pkey"
			tableName="adm_script_exec_role" />

		<addForeignKeyConstraint baseColumnNames="script_instance_id"
			baseTableName="adm_script_exec_role" constraintName="fk_script_instance"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
		
		<addForeignKeyConstraint baseColumnNames="role_id"
			baseTableName="adm_script_exec_role" constraintName="fk_role"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_role" />
			
		<createTable tableName="adm_script_sourc_role">
			<column name="script_instance_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="role_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addPrimaryKey columnNames="script_instance_id, role_id" constraintName="adm_script_sourc_role_pkey"
			tableName="adm_script_sourc_role" />

		<addForeignKeyConstraint baseColumnNames="script_instance_id"
			baseTableName="adm_script_sourc_role" constraintName="fk_script_instance"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
		
		<addForeignKeyConstraint baseColumnNames="role_id"
			baseTableName="adm_script_sourc_role" constraintName="fk_role"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_role" />
	</changeSet>
	<changeSet id="#1103-20151224" author="TyshanShi">
		<addColumn tableName="meveo_module">
			<column name="LOGO_FORMAT" type="varchar(20)"></column>
			<column name="COORDS_LOGO" type="varchar(255)"></column>
		</addColumn>
	</changeSet>
	<changeSet id="#1103-20160104" author="TyshanShi">
		<dropColumn tableName="meveo_module" columnName="LOGO_FORMAT"/>
		<dropColumn tableName="meveo_module" columnName="COORDS_LOGO"/>
		<addColumn tableName="meveo_module">
			<column name="LOGO_PICTURE" type="varchar(255)"/>
		</addColumn>
	</changeSet>

	<changeSet id="#1381-20160105" author="EdwardLegaspi">
		<createSequence sequenceName="cat_offer_template_category_seq" />

		<createTable tableName="cat_offer_template_category">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="disabled" type="BOOL">
				<constraints nullable="false" />
			</column>
			<column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
			<column name="creator_id" type="BIGINT" />
			<column name="updater_id" type="BIGINT" />
			<column name="provider_id" type="BIGINT" />
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(100)" />
			<column name="UUID" type="VARCHAR(50)" />
			<column name="name" type="VARCHAR(100)" />
			<column name="image" type="oid" />
		</createTable>

		<addPrimaryKey columnNames="id"
			constraintName="pk_cat_offer_template_category" tableName="cat_offer_template_category" />
		<addUniqueConstraint columnNames="code, provider_id"
			constraintName="uk_cat_offer_template_category" deferrable="false"
			disabled="false" initiallyDeferred="false" tableName="cat_offer_template_category" />
		<addForeignKeyConstraint baseColumnNames="creator_id"
			baseTableName="cat_offer_template_category" constraintName="fk_cot_category_adm_user_creator"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		<addForeignKeyConstraint baseColumnNames="updater_id"
			baseTableName="cat_offer_template_category" constraintName="fk_cot_category_adm_user_updater"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />

		<addColumn tableName="cat_offer_template">
			<column name="name" type="VARCHAR(100)" />
			<column name="entity_version" type="INT4" />
			<column name="image" type="oid" />
			<column name="cat_offer_template_cat_id" type="BIGINT" />
			<column name="status" type="VARCHAR(50)" />
		</addColumn>

		<addForeignKeyConstraint baseColumnNames="cat_offer_template_cat_id"
			baseTableName="cat_offer_template" constraintName="fk_cat_offer_template_offer_template_category"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id"
			referencedTableName="cat_offer_template_category" />
			
		<!-- migration -->
		<sql>UPDATE cat_offer_template SET name=DESCRIPTION;</sql>
	</changeSet>


    <changeSet id="#1104_20160102" author="AndriusKarpavicius">
        <addColumn tableName="MEVEO_SCRIPT_INSTANCE">
            <column name="APPLIES_TO" type="varchar(100)"/>
            <column name="APPLICABLE_ON_EL" type="varchar(150)"/>
            <column name="LABEL" type="varchar(50)"/>
            <column name="SCRIPT_TYPE" type="varchar(20)"/>
        </addColumn>
        <sql>update MEVEO_SCRIPT_INSTANCE set SCRIPT_TYPE='ScriptInstance'</sql>
    </changeSet>

	<changeSet id="#1381-20160107" author="EdwardLegaspi">
		<addColumn tableName="cat_offer_template_category">
			<column name="OFFER_TEMPLATE_CATEGORY_ID" type="BIGINT" />
		</addColumn>

		<addForeignKeyConstraint baseColumnNames="OFFER_TEMPLATE_CATEGORY_ID"
			baseTableName="cat_offer_template_category" constraintName="fk_offer_cat_template_offer_cat_template"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id"
			referencedTableName="cat_offer_template_category" />
	</changeSet>

	<changeSet id="#1381-20160108" author="EdwardLegaspi">
		<addColumn tableName="cat_offer_template_category">
			<column name="level" type="INT" />
			<column name="image_content_type" type="VARCHAR(50)" />
		</addColumn>
		
		<sql>UPDATE cat_offer_template_category SET level=1;</sql>
	</changeSet>	
	
	<changeSet id="#1399-20160113" author="EdwardLegaspi">
		<addUniqueConstraint columnNames="provider_id, invoice_number, invoice_type" tableName="billing_invoice" />
	</changeSet>
    
    <changeSet id="#1424_20160119" author="SebastienMichea">
        <addColumn tableName="DWH_MEASURED_VALUE">
            <column name="DIMENSION_1" type="VARCHAR(255)"/>
            <column name="DIMENSION_2" type="VARCHAR(255)"/>
            <column name="DIMENSION_3" type="VARCHAR(255)"/>
            <column name="DIMENSION_4" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>    

	<changeSet id="#1365_20160119" author="anasseh">
		<addColumn tableName="CAT_CHARGE_TEMPLATE">
			<column name="ROUNDING_MODE" type="VARCHAR(255)" defaultValue="NEAREST" />
		</addColumn>

		<sql>UPDATE CAT_CHARGE_TEMPLATE SET ROUNDING_MODE='NEAREST';</sql>
	</changeSet>    
    
    <changeSet id="#1104_20160102-1" author="AndriusKarpavicius">
        <dropTable tableName="meveo_script_instance_error"/>
    </changeSet>

	<changeSet id="#1450_20160202" author="EdwardLegaspi">
		<createTable tableName="cat_business_offer_model">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="offer_template_id" type="BIGINT" />
			<column name="script_instance_id" type="BIGINT" />
		</createTable>

		<addPrimaryKey columnNames="id" constraintName="pk_cat_bom"
			tableName="cat_business_offer_model" />
		<addForeignKeyConstraint baseColumnNames="id"
			baseTableName="cat_business_offer_model" constraintName="fk_cat_bom_meveo_module"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_module" />
		<addForeignKeyConstraint baseColumnNames="offer_template_id"
			baseTableName="cat_business_offer_model" constraintName="fk_cat_bom_offer_template"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
		<addForeignKeyConstraint baseColumnNames="script_instance_id"
			baseTableName="cat_business_offer_model" constraintName="fk_cat_bom_meveo_script_instance"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />

		<createTable tableName="cat_business_serv_model">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="service_template_id" type="BIGINT" />
			<column name="script_instance_id" type="BIGINT" />
		</createTable>

		<addPrimaryKey columnNames="id" constraintName="pk_cat_bsm"
			tableName="cat_business_serv_model" />
		<addForeignKeyConstraint baseColumnNames="id"
			baseTableName="cat_business_serv_model" constraintName="fk_cat_bsm_meveo_module"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_module" />
		<addForeignKeyConstraint baseColumnNames="service_template_id"
			baseTableName="cat_business_serv_model" constraintName="fk_cat_bsm_service_template"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
		<addForeignKeyConstraint baseColumnNames="script_instance_id"
			baseTableName="cat_business_serv_model" constraintName="fk_cat_bsm_meveo_script_instance"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />

		<createTable tableName="cat_offer_service_template">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="provider_id" type="BIGINT" />
			<column name="offer_template_id" type="BIGINT" />
			<column name="service_template_id" type="BIGINT" />
			<column name="mandatory" type="BOOL" />
		</createTable>

		<createSequence sequenceName="cat_offer_serv_templt_seq" />
		<addPrimaryKey columnNames="id"
			constraintName="pk_cat_offer_service_template" tableName="cat_offer_service_template" />
		<addForeignKeyConstraint baseColumnNames="offer_template_id"
			baseTableName="cat_offer_service_template" constraintName="fk_cat_ost_offer_template"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
		<addForeignKeyConstraint baseColumnNames="service_template_id"
			baseTableName="cat_offer_service_template" constraintName="fk_cat_ost_service_template"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

		<createTable tableName="cat_offer_serv_incomp">
			<column name="offer_template_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="offer_service_template_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint baseColumnNames="offer_template_id"
			baseTableName="cat_offer_serv_incomp" constraintName="fk_cat_os_incomp_offer_template"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id"
			referencedTableName="cat_offer_service_template" />
		<addForeignKeyConstraint baseColumnNames="offer_service_template_id"
			baseTableName="cat_offer_serv_incomp" constraintName="fk_cat_os_incomp_service_template"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

		<createTable tableName="cat_offer_serv_assoc">
			<column name="offer_template_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="offer_service_template_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint baseColumnNames="offer_template_id"
			baseTableName="cat_offer_serv_assoc" constraintName="fk_cat_os_assoc_offer_template"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
		<addForeignKeyConstraint baseColumnNames="offer_service_template_id"
			baseTableName="cat_offer_serv_assoc" constraintName="fk_cat_os_assoc_service_template"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

		<addColumn tableName="cat_offer_template">
			<column name="business_offer_model_id" type="BIGINT"></column>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="business_offer_model_id"
			baseTableName="cat_offer_template" constraintName="fk_cat_offer_template_bom"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_business_offer_model" />

		<addColumn tableName="cat_service_template">
			<column name="business_service_model_id" type="BIGINT"></column>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="business_service_model_id"
			baseTableName="cat_service_template" constraintName="fk_cat_service_template_bsm"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_business_serv_model" />
	</changeSet>  
	
	<changeSet id="#1186_20160201" author="anasseh">
	    <modifyDataType columnName="BODY_EL" newDataType="VARCHAR(2000)"
			tableName="ADM_NOTIF_WEBHOOKS" /> 
	   	</changeSet>

	<changeSet id="#1450_20160202-1" author="EdwardLegaspi">
		<addPrimaryKey columnNames="offer_template_id, offer_service_template_id"
			constraintName="pk_cat_offer_serv_incomp" tableName="cat_offer_serv_incomp" />
		<addPrimaryKey columnNames="offer_template_id, offer_service_template_id"
			constraintName="pk_cat_offer_serv_assoc" tableName="cat_offer_serv_assoc" />

		<dropForeignKeyConstraint baseTableName="cat_offer_serv_assoc"
			constraintName="fk_cat_os_assoc_service_template" />
		<addForeignKeyConstraint baseColumnNames="offer_service_template_id"
			baseTableName="cat_offer_serv_assoc" constraintName="fk_cat_os_assoc_offer_service_template"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id"
			referencedTableName="cat_offer_service_template" />
	</changeSet>
     <changeSet id="#1464-20160203" author="anasseh">		
		<modifyDataType columnName="INVOICE_PREFIX" newDataType="VARCHAR(2000)" tableName="CRM_SELLER" />	
		<modifyDataType columnName="INVOICE_ADJUSTMENT_PREFIX" newDataType="VARCHAR(2000)" tableName="CRM_SELLER" />
		<modifyDataType columnName="INVOICE_PREFIX" newDataType="VARCHAR(2000)" tableName="CRM_PROVIDER" />	
		<modifyDataType columnName="INVOICE_ADJUSTMENT_PREFIX" newDataType="VARCHAR(2000)" tableName="CRM_PROVIDER" />																																
	</changeSet>
    <changeSet id="#1360_20160206" author="AndriusKarpavicius">
        <createTable tableName="CRM_CUSTOM_FIELD_TMPL_MCOLS">
            <column name="CFT_ID" type="BIGINT" />
            <column name="POSITION" type="INT" />
            <column name="CODE" type="VARCHAR(20)" />
            <column name="LABEL" type="VARCHAR(50)" />
            <column name="KEY_TYPE" type="INT" />
        </createTable>
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL_MCOLS" columnName="POSITION" />
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL_MCOLS" columnName="CFT_ID" />
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL_MCOLS" columnName="CODE" />
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL_MCOLS" columnName="LABEL" />
        <addNotNullConstraint tableName="CRM_CUSTOM_FIELD_TMPL_MCOLS" columnName="KEY_TYPE" />
        <addForeignKeyConstraint constraintName="FK_CFT_MCOLS_CFT" referencedTableName="CRM_CUSTOM_FIELD_TMPL" baseColumnNames="CFT_ID" baseTableName="CRM_CUSTOM_FIELD_TMPL_MCOLS"
            referencedColumnNames="ID" />
    </changeSet>
	
     <changeSet id="#barchart-20160206" author="smichea">		
		<addColumn tableName="dwh_chart">
			<column name="width" type="VARCHAR(10)"></column>
		</addColumn>
		<sql>UPDATE DWH_CHART SET WIDTH='500px';</sql>
	</changeSet>
     <changeSet id="#barchart-20160208" author="smichea">		
		<addColumn tableName="dwh_chart">
			<column name="height" type="VARCHAR(10)"></column>
		</addColumn>
		<sql>UPDATE DWH_CHART SET HEIGHT='300px';</sql>
	</changeSet>
     <changeSet id="#barchart-20160209" author="smichea">		
		<addColumn tableName="dwh_measurable_quant">
			<column name="additive" type="BOOL"></column>
		</addColumn>
		<sql>UPDATE dwh_measurable_quant SET additive=TRUE;</sql>
	</changeSet>

	 <changeSet id="#dwh-20160209" author="smichea">		
		<addColumn tableName="DWH_MEASURED_VALUE">
			<column name="CODE" type="VARCHAR(60)"></column>
		</addColumn>
		<sql>UPDATE DWH_MEASURED_VALUE SET CODE = (SELECT CODE FROM dwh_measurable_quant WHERE dwh_measurable_quant.id=DWH_MEASURED_VALUE.MEASURABLE_QUANTITY)</sql>
		<addNotNullConstraint tableName="DWH_MEASURED_VALUE" columnName="CODE"/>
		<addColumn tableName="dwh_measurable_quant">
			<column name="VISIBLE" type="BOOL"></column>
		</addColumn>
		<sql>UPDATE dwh_measurable_quant SET VISIBLE=TRUE;</sql>
	</changeSet>
	<changeSet id="#barchart-20160210" author="smichea">		
		<addColumn tableName="dwh_chart"> 
			<column name="VISIBLE" type="BOOL"></column>
		</addColumn> 
	</changeSet>
    
    <changeSet id="#1101_20160224" author="AndriusKarpavicius">
        <dropUniqueConstraint tableName="crm_custom_field_inst" constraintName="uk_crm_custom_field_inst" />
        <addUniqueConstraint columnNames="APPLIES_TO_UUID, code, period_start_date, period_end_date, provider_id" tableName="crm_custom_field_inst" constraintName="uk_crm_custom_field_inst" />
    </changeSet>
    <changeSet id="#1516_20160224" author="AndriusKarpavicius">
        <dropTable tableName="CAT_OFFER_SERV_ASSOC"/>
    </changeSet>
    <changeSet id="#1450_20160226" author="AndriusKarpavicius">
        <renameColumn tableName="cat_offer_serv_incomp" oldColumnName="offer_service_template_id" newColumnName="service_template_id"/>
        <renameColumn tableName="cat_offer_serv_incomp" oldColumnName="offer_template_id" newColumnName="offer_service_template_id"/>
    </changeSet>
    
    <changeSet id="#1450_20160226-1" author="AndriusKarpavicius">    
        <addColumn tableName="cat_offer_serv_templates">
            <column name="id" type="BIGINT"/>
            <column name="version" type="INT4" />
            <column name="provider_id" type="BIGINT" />
            <column name="mandatory" type="BOOL" defaultValueBoolean="false"/>        
        </addColumn>

        <sql>update cat_offer_serv_templates set id=offer_template_id, version=0</sql>
        <sql>update cat_offer_serv_templates set provider_id = (select provider_id from cat_offer_template where cat_offer_template.id=cat_offer_serv_templates.offer_template_id)</sql>
        <sql>update cat_offer_serv_templates set id = (select nextval('CAT_OFFER_SERV_TEMPLT_SEQ') from cat_offer_serv_templates as oo where oo.offer_template_id=cat_offer_serv_templates.offer_template_id and oo.service_template_id=cat_offer_serv_templates.service_template_id)</sql>


        <addNotNullConstraint tableName="cat_offer_serv_templates" columnName="id"/>
        <addPrimaryKey columnNames="id" constraintName="pk_cat_offer_serv_templates" tableName="cat_offer_serv_templates" />
        <addUniqueConstraint columnNames="provider_id, offer_template_id, service_template_id" tableName="cat_offer_serv_templates" constraintName="uk_cat_offer_serv_templates" />
        
        <dropForeignKeyConstraint baseTableName="cat_offer_serv_incomp" constraintName="fk_cat_os_incomp_offer_template"/>
        
        <sql>delete from cat_offer_serv_incomp</sql>
        
        <addForeignKeyConstraint baseColumnNames="offer_service_template_id"
            baseTableName="cat_offer_serv_incomp" constraintName="fk_cat_os_incomp_offer_template"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id"
            referencedTableName="cat_offer_serv_templates" />
            
        <dropTable tableName="cat_offer_service_template"/>
        
    </changeSet>

    <changeSet id="#1103-20160226" author="AndriusKarpavicius">        
        <modifyDataType tableName="MEVEO_MODULE_ITEM" columnName="ITEM_TYPE" newDataType="VARCHAR(100)" />
        
        <sql>update MEVEO_MODULE_ITEM set ITEM_TYPE='org.meveo.model.customEntities.CustomEntityTemplate' where ITEM_TYPE='CET' </sql> 
        <sql>update MEVEO_MODULE_ITEM set ITEM_TYPE='org.meveo.model.crm.CustomFieldTemplate' where ITEM_TYPE='CFT' </sql>
        <sql>update MEVEO_MODULE_ITEM set ITEM_TYPE='org.meveo.model.filter.Filter' where ITEM_TYPE='FILTER' </sql>
        <sql>update MEVEO_MODULE_ITEM set ITEM_TYPE='org.meveo.model.scripts.ScriptInstance' where ITEM_TYPE='SCRIPT' </sql>
        <sql>update MEVEO_MODULE_ITEM set ITEM_TYPE='org.meveo.model.jobs.JobInstance' where ITEM_TYPE='JOBINSTANCE' </sql>
        <sql>update MEVEO_MODULE_ITEM set ITEM_TYPE='org.meveo.model.notification.Notification' where ITEM_TYPE='NOTIFICATION' </sql>
        <sql>update MEVEO_MODULE_ITEM set ITEM_TYPE='org.meveo.model.module.MeveoModule' where ITEM_TYPE='SUBMODULE' </sql>
        <sql>update MEVEO_MODULE_ITEM set ITEM_TYPE='org.meveocrm.model.dwh.MeasurableQuantity' where ITEM_TYPE='MEASURABLEQUANTITIES' </sql>
        <sql>update MEVEO_MODULE_ITEM set ITEM_TYPE='org.meveocrm.model.dwh.Chart' where ITEM_TYPE='CHART' </sql>
    </changeSet>
    
     <changeSet id="#20160229" author="EdwardLegaspi">
     	<addColumn tableName="cat_business_serv_model">
     		<column name="duplicate_service" type="BOOL" defaultValueBoolean="false"/>
     		<column name="duplicate_price_plan" type="BOOL" defaultValueBoolean="false"/>
     	</addColumn>        
     </changeSet>
    <changeSet id="#1478-20160302" author="AndriusKarpavicius">
        <dropTable tableName="crm_provider_config"/>
        <dropSequence sequenceName="crm_provider_config_seq"/>
        <dropUniqueConstraint tableName="billing_invoice_configuration" constraintName="uk_billing_invoice_configuration"/>
        <dropColumn tableName="billing_invoice_configuration" columnName="code"/>
        <dropColumn tableName="billing_invoice_configuration" columnName="description"/>
        <dropColumn tableName="billing_invoice_configuration" columnName="created"/>
        <dropColumn tableName="billing_invoice_configuration" columnName="updated"/>
        <dropColumn tableName="billing_invoice_configuration" columnName="creator_id"/>
        <dropColumn tableName="billing_invoice_configuration" columnName="updater_id"/>
        <dropColumn tableName="billing_invoice_configuration" columnName="disabled"/>
        <addUniqueConstraint columnNames="provider_id" constraintName="uk_billing_invoice_configuration" deferrable="false" disabled="false"
            initiallyDeferred="false" tableName="billing_invoice_configuration" />
    </changeSet>
      <changeSet id="#1517-20160301" author="AndriusKarpavicius">
        <modifyDataType tableName="CRM_CUSTOM_FIELD_INST" columnName="APPLIES_TO_UUID" newDataType="VARCHAR(60)"/>
        <modifyDataType tableName="MEDINA_ACCESS" columnName="UUID" newDataType="VARCHAR(60)"/>
        <modifyDataType tableName="CRM_PROVIDER" columnName="UUID" newDataType="VARCHAR(60)"/>
        <modifyDataType tableName="ACCOUNT_ENTITY" columnName="UUID" newDataType="VARCHAR(60)"/>
        <modifyDataType tableName="CAT_CHARGE_TEMPLATE" columnName="UUID" newDataType="VARCHAR(60)"/>
        <modifyDataType tableName="MEVEO_JOB_INSTANCE" columnName="UUID" newDataType="VARCHAR(60)"/>
        <modifyDataType tableName="CAT_OFFER_TEMPLATE" columnName="UUID" newDataType="VARCHAR(60)"/>
        <modifyDataType tableName="CRM_SELLER" columnName="UUID" newDataType="VARCHAR(60)"/>
        <modifyDataType tableName="CAT_SERVICE_TEMPLATE" columnName="UUID" newDataType="VARCHAR(60)"/>
        <modifyDataType tableName="BILLING_SUBSCRIPTION" columnName="UUID" newDataType="VARCHAR(60)"/>
        <modifyDataType tableName="CUST_CEI" columnName="UUID" newDataType="VARCHAR(60)"/>
        <modifyDataType tableName="cat_offer_template_category" columnName="UUID" newDataType="VARCHAR(60)"/>
      </changeSet>
    
    <changeSet id="#1531-20160304" author="AndriusKarpavicius">
        <addColumn tableName="BILLING_SERVICE_INSTANCE">
            <column name="UUID" type="VARCHAR(60)"/>
        </addColumn>
        <sql>update BILLING_SERVICE_INSTANCE set UUID ='ServiceInstance-'|| id </sql>  
    </changeSet>        

    <changeSet id="#1551-20160314" author="AndriusKarpavicius">
        <modifyDataType tableName="crm_custom_field_inst" columnName="serialized_value" newDataType="text"/>
    </changeSet>
    
    <changeSet id="#1556-20160315" author="SebastienMichea">
        <addColumn tableName="CAT_PRICE_PLAN_MATRIX">
            <column name="UUID" type="VARCHAR(60)"/>
        </addColumn>
        <sql>update CAT_PRICE_PLAN_MATRIX set UUID ='PricePlanMatrix-'|| id </sql>  
    </changeSet>        
    
    <changeSet id="#1556_20160316" author="SebastienMichea">
		<addColumn tableName="BILLING_INVOICE_CONFIGURATION">
			<column name="DISPLAY_PRICEPLANS" type="BOOL" defaultValueBoolean="false"></column>
			<column name="DISPLAY_CF_AS_XML" type="BOOL" defaultValueBoolean="false"></column>
		</addColumn>
	</changeSet>
	
    <changeSet id="#1528_20160311" author="anasseh">
        <addColumn tableName="CRM_PROVIDER">
            <column name="EXONERATION_TAX_EL" type="VARCHAR(2000)" />
        </addColumn>        
    </changeSet>  	

    <changeSet id="#1585_20160325" author="AndriusKarpavicius">
        <sql>update MEVEO_JOB_INSTANCE set disabled=not(active)</sql>
        <dropColumn tableName="MEVEO_JOB_INSTANCE" columnName="ACTIVE"/>
    </changeSet>    

    <changeSet id="#1528_20160311_2" author="anasseh">	
        <addColumn tableName="CRM_CUSTOMER_CATEGORY">	
            <column name="EXONERATION_TAX_EL" type="VARCHAR(2000)" />    
            <column name="EXONERATION_REASON" type="VARCHAR(255)" />          
        </addColumn>   
        <dropColumn columnName="EXONERATION_TAX_EL" tableName="CRM_PROVIDER" />
    </changeSet>    
    <changeSet id="#1588_20160412" author="AndriusKarpavicius">
        <dropNotNullConstraint tableName="adm_notif_webhooks" columnName="HTTP_PORT"/>  

        <modifyDataType tableName="ADM_NOTIF_EMAIL" columnName="EMAIL_BODY" newDataType="TEXT"/>
        <modifyDataType tableName="ADM_NOTIF_EMAIL" columnName="EMAIL_HTML_BODY" newDataType="TEXT"/>
    </changeSet>   
         
    <changeSet id="#1640_20160413" author="anasseh">	
        <addColumn tableName="AR_DDREQUEST_ITEM">	
            <column name="ERROR_MSG" type="VARCHAR(1000)" />             
        </addColumn>   
        <addColumn tableName="AR_DDREQUEST_LOT">	
            <column name="FILE_FORMAT" type="VARCHAR(100)" />             
        </addColumn>     
        <addColumn tableName="AR_DDREQUEST_LOT_OP">	
            <column name="FILE_FORMAT" type="VARCHAR(100)" />             
        </addColumn>    
        <dropColumn tableName="AR_DDREQUEST_ITEM" columnName="CUSTOMER_ACCOUNT_ID"/>
        <dropColumn tableName="AR_ACCOUNT_OPERATION" columnName="ddrequestlot_id"/>  
         <dropColumn tableName="AR_ACCOUNT_OPERATION" columnName="ddrequest_item_id"/> 
        
        <addColumn tableName="AR_DDREQUEST_ITEM">	
            <column name="ACCOUNT_OPERATION_ID" type="BIGINT"></column>            
        </addColumn>      
		<addForeignKeyConstraint baseColumnNames="ACCOUNT_OPERATION_ID"
			baseTableName="AR_DDREQUEST_ITEM" constraintName="fk_ar_occ_dd_item"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_account_operation" />                   
    </changeSet>
    
    <changeSet id="#1548_20160421" author="AndriusKarpavicius">
        <modifyDataType tableName="MEVEO_SCRIPT_INSTANCE" columnName="APPLICABLE_ON_EL" newDataType="varchar(2000)"/>
        <addNotNullConstraint tableName="CUST_CEI" columnName="CET_CODE"/>
        <addNotNullConstraint tableName="CUST_CET" columnName="name"/>
        <addNotNullConstraint tableName="CAT_OFFER_TEMPLATE_CATEGORY" columnName="NAME"/>
    </changeSet>
    
    <changeSet id="#1651-20160421" author="Mbarek">
	<modifyDataType columnName="APPLICABLE_ON_EL"
		newDataType="VARCHAR(2000)" tableName="CRM_CUSTOM_FIELD_TMPL" />
    </changeSet>

    <changeSet id="#1649_20160427" author="AndriusKarpavicius">
        <sql>update crm_custom_field_tmpl tm set provider_id = (select provider_id from adm_user where id = tm.creator_id) where tm.provider_id is null;</sql>    
    </changeSet>
    
    <changeSet id="#1611_20160429" author="EdwardLegaspi">
    	<addColumn tableName="adm_inbound_request">
    		<column name="body" type="TEXT"></column>
    	</addColumn>
    </changeSet>
    
    
     <changeSet id="#1656_20160501" author="Mbarek">
		<addColumn tableName="BILLING_INVOICE_CONFIGURATION">
			<column name="DISPLAY_CHARGES_PERIODS" type="BOOL" defaultValueBoolean="false"></column> 
		</addColumn>
	</changeSet>
	
	<changeSet id="#1679_20160504" author="EdwardLegaspi">
		<createTable tableName="crm_business_account_model">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="script_instance_id" type="BIGINT" />
			<column name="type" type="VARCHAR(20)">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>
	
	  <changeSet author="smichea" id="financeModule_2016_05_05">
        <createSequence sequenceName="ar_revenue_recog_rule_seq" />
        <createTable tableName="ar_revenue_recog_rule">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
            <column name="disabled" type="BOOL" defaultValueBoolean="false"/> 
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false" />
            </column>
			<column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
			<column name="provider_id" type="BIGINT" />
			<column name="creator_id" type="BIGINT" />
			<column name="updater_id" type="BIGINT" />
            <column name="code" type="VARCHAR(60)"/>
            <column name="description" type="VARCHAR(100)"/>
            <column name="script_instance_id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="start_delay" type="INT4"/>
            <column name="start_unit" type="VARCHAR(20)"/>
            <column name="start_event" type="VARCHAR(20)"/>
            <column name="stop_delay" type="INT4"/>
            <column name="stop_unit" type="VARCHAR(20)"/>
            <column name="stop_event" type="VARCHAR(20)"/>
        </createTable>
        <addPrimaryKey columnNames="id" constraintName="ar_revenue_recog_rule_pkey" tableName="ar_revenue_recog_rule" />
        <addForeignKeyConstraint baseColumnNames="provider_id" baseTableName="ar_revenue_recog_rule" constraintName="fk_ar_revenue_recog_rule_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
        <addForeignKeyConstraint baseColumnNames="creator_id" baseTableName="ar_revenue_recog_rule" constraintName="fk_ar_revenue_recog_rule_creator"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
        <addForeignKeyConstraint baseColumnNames="updater_id" baseTableName="ar_revenue_recog_rule" constraintName="fk_ar_revenue_recog_rule_updator"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
        <addForeignKeyConstraint baseColumnNames="script_instance_id" baseTableName="ar_revenue_recog_rule" constraintName="fk_ar_revenue_recog_rule_script"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
        <addColumn tableName="CAT_CHARGE_TEMPLATE">
	            <column name="REVENUE_RECOG_RULE_ID" type="BIGINT" />
	    </addColumn>
	    <addForeignKeyConstraint baseColumnNames="REVENUE_RECOG_RULE_ID" baseTableName="CAT_CHARGE_TEMPLATE" constraintName="fk_CAT_CHARGE_TEMPLATE_RECOG_RULE"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="AR_REVENUE_RECOG_RULE" />
        <addColumn tableName="CRM_PROVIDER">
	            <column name="RECOGNIZE_REVENUE"  type="BOOL" defaultValueBoolean="false"/>
	    </addColumn>
    </changeSet>
    <changeSet author="smichea" id="financeModule_2016_05_10">
        <createSequence sequenceName="ar_revenue_schedule_seq" />
        <createTable tableName="ar_revenue_schedule">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
			<column name="provider_id" type="BIGINT" />
            <column name="charge_instance_id" type="BIGINT">
                <constraints nullable="false" />
            </column>
			<column name="revenue_date" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="recognized_revenue" type="numeric(23, 12)"/>
            <column name="invoiced_revenue" type="numeric(23, 12)"/>
            <column name="accrued_revenue" type="numeric(23, 12)"/>
            <column name="deffered_revenue" type="numeric(23, 12)"/>
        </createTable>
        <addPrimaryKey columnNames="id" constraintName="ar_revenue_schedule_pkey" tableName="ar_revenue_schedule" />
        <addForeignKeyConstraint baseColumnNames="provider_id" baseTableName="ar_revenue_schedule" constraintName="fk_ar_revenue_schedule_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
        <addForeignKeyConstraint baseColumnNames="charge_instance_id" baseTableName="ar_revenue_schedule" constraintName="fk_ar_revenue_schedule_charge"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_charge_instance" />
    </changeSet>

	<changeSet id="#1679_20160509" author="EdwardLegaspi">
		<addForeignKeyConstraint constraintName="fk_crm_business_account_model_accountmodel"
			referencedTableName="meveo_script_instance" baseColumnNames="script_instance_id"
			baseTableName="crm_business_account_model" referencedColumnNames="id" />
	</changeSet>
	
   
    <changeSet id="#1686-20160512" author="anasseh">
        <addColumn tableName="BILLING_INVOICE">
            <column name="UUID" type="VARCHAR(60)"/>
        </addColumn>
        <sql>update BILLING_INVOICE set UUID ='Invoice-'|| id </sql>  
        
        <addColumn tableName="BILLING_INVOICE_CAT">
            <column name="UUID" type="VARCHAR(60)"/>
        </addColumn>
        <sql>update BILLING_INVOICE_CAT set UUID ='InvoiceCategory-'|| id </sql>     
        
       <addColumn tableName="BILLING_INVOICE_SUB_CAT">
            <column name="UUID" type="VARCHAR(60)"/>
        </addColumn>
        <sql>update BILLING_INVOICE_SUB_CAT set UUID ='InvoiceSubCategory-'|| id </sql>  
        
       <addColumn tableName="AR_ACCOUNT_OPERATION">
            <column name="UUID" type="VARCHAR(60)"/>
        </addColumn>
        <sql>update AR_ACCOUNT_OPERATION set UUID ='AccountOperation-'|| id </sql>          
    </changeSet> 
    
	<changeSet id="#1666_20160503" author="mhammam">
		<addColumn tableName="ADM_COUNTRY">
			<column name="DESCRIPTION_FR" type="VARCHAR(100)" /> 
		</addColumn>
	</changeSet>
    
    <changeSet id="#1487_20160503" author="AndriusKarpavicius">
        <addColumn tableName="CUST_CEI">
            <column name="PARENT_UUID" type="VARCHAR(60)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#1671_20150504" author="AndriusKarpavicius">
        <sql>
            update CAT_COUNTER_TEMPLATE set CEILING_EXPRESSION_EL=replace(CEILING_EXPRESSION_EL,'.mapValue[','[')  where CEILING_EXPRESSION_EL is not null and CEILING_EXPRESSION_EL like '%mv:%';
            update CAT_COUNTER_TEMPLATE set CEILING_EXPRESSION_EL=replace(CEILING_EXPRESSION_EL,'.listValue','')  where CEILING_EXPRESSION_EL is not null and CEILING_EXPRESSION_EL like '%mv:%';
            update CAT_DISCOUNT_PLAN_ITEM set EXPRESSION_EL=replace(EXPRESSION_EL,'.mapValue[','[')  where EXPRESSION_EL is not null and EXPRESSION_EL like '%mv:%';
            update CAT_DISCOUNT_PLAN_ITEM set EXPRESSION_EL=replace(EXPRESSION_EL,'.listValue','')  where EXPRESSION_EL is not null and EXPRESSION_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set SUBSCRIPTION_EL=replace(SUBSCRIPTION_EL,'.mapValue[','[')  where SUBSCRIPTION_EL is not null and SUBSCRIPTION_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set SUBSCRIPTION_EL=replace(SUBSCRIPTION_EL,'.listValue','')  where SUBSCRIPTION_EL is not null and SUBSCRIPTION_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set CONDITION_EL=replace(CONDITION_EL,'.mapValue[','[')  where CONDITION_EL is not null and CONDITION_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set CONDITION_EL=replace(CONDITION_EL,'.listValue','')  where CONDITION_EL is not null and CONDITION_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set QUANTITY_EL=replace(QUANTITY_EL,'.mapValue[','[')  where QUANTITY_EL is not null and QUANTITY_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set QUANTITY_EL=replace(QUANTITY_EL,'.listValue','')  where QUANTITY_EL is not null and QUANTITY_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_1_EL=replace(PARAM_1_EL,'.mapValue[','[')  where PARAM_1_EL is not null and PARAM_1_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_1_EL=replace(PARAM_1_EL,'.listValue','')  where PARAM_1_EL is not null and PARAM_1_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_2_EL=replace(PARAM_2_EL,'.mapValue[','[')  where PARAM_2_EL is not null and PARAM_2_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_2_EL=replace(PARAM_2_EL,'.listValue','')  where PARAM_2_EL is not null and PARAM_2_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_3_EL=replace(PARAM_3_EL,'.mapValue[','[')  where PARAM_3_EL is not null and PARAM_3_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_3_EL=replace(PARAM_3_EL,'.listValue','')  where PARAM_3_EL is not null and PARAM_3_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_4_EL=replace(PARAM_4_EL,'.mapValue[','[')  where PARAM_4_EL is not null and PARAM_4_EL like '%mv:%';
            update CAT_TRIGGERED_EDR set PARAM_4_EL=replace(PARAM_4_EL,'.listValue','')  where PARAM_4_EL is not null and PARAM_4_EL like '%mv:%';
            update MEVEO_NATIVE_FILTER_CONDITION set EL=replace(EL,'.mapValue[','[')  where EL is not null and EL like '%mv:%';
            update MEVEO_NATIVE_FILTER_CONDITION set EL=replace(EL,'.listValue','')  where EL is not null and EL like '%mv:%';
            update ADM_NOTIF_EMAIL set EMAIL_TO_EL=replace(EMAIL_TO_EL,'.mapValue[','[')  where EMAIL_TO_EL is not null and EMAIL_TO_EL like '%mv:%';
            update ADM_NOTIF_EMAIL set EMAIL_TO_EL=replace(EMAIL_TO_EL,'.listValue','')  where EMAIL_TO_EL is not null and EMAIL_TO_EL like '%mv:%';
            update ADM_NOTIF_WEBHOOKS set BODY_EL=replace(BODY_EL,'.mapValue[','[')  where BODY_EL is not null and BODY_EL like '%mv:%';
            update ADM_NOTIF_WEBHOOKS set BODY_EL=replace(BODY_EL,'.listValue','')  where BODY_EL is not null and BODY_EL like '%mv:%';
            update ADM_NOTIF_IM set ID_EXPRESSION=replace(ID_EXPRESSION,'.mapValue[','[')  where ID_EXPRESSION is not null and ID_EXPRESSION like '%mv:%';
            update ADM_NOTIF_IM set ID_EXPRESSION=replace(ID_EXPRESSION,'.listValue','')  where ID_EXPRESSION is not null and ID_EXPRESSION like '%mv:%';
            update ADM_NOTIFICATION set EVENT_EXPRESSION_FILTER=replace(EVENT_EXPRESSION_FILTER,'.mapValue[','[')  where EVENT_EXPRESSION_FILTER is not null and EVENT_EXPRESSION_FILTER like '%mv:%';
            update ADM_NOTIFICATION set EVENT_EXPRESSION_FILTER=replace(EVENT_EXPRESSION_FILTER,'.listValue','')  where EVENT_EXPRESSION_FILTER is not null and EVENT_EXPRESSION_FILTER like '%mv:%';
            update AR_ACTION_PLAN_ITEM set CONDITION_EL=replace(CONDITION_EL,'.mapValue[','[')  where CONDITION_EL is not null and CONDITION_EL like '%mv:%';
            update AR_ACTION_PLAN_ITEM set CONDITION_EL=replace(CONDITION_EL,'.listValue','')  where CONDITION_EL is not null and CONDITION_EL like '%mv:%';
            update AR_DUNNING_PLAN_TRANSITION set CONDITION_EL=replace(CONDITION_EL,'.mapValue[','[')  where CONDITION_EL is not null and CONDITION_EL like '%mv:%';
            update AR_DUNNING_PLAN_TRANSITION set CONDITION_EL=replace(CONDITION_EL,'.listValue','')  where CONDITION_EL is not null and CONDITION_EL like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set CRITERIA_EL=replace(CRITERIA_EL,'.mapValue[','[')  where CRITERIA_EL is not null and CRITERIA_EL like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set CRITERIA_EL=replace(CRITERIA_EL,'.listValue','')  where CRITERIA_EL is not null and CRITERIA_EL like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set AMOUNT_WITHOUT_TAX_EL=replace(AMOUNT_WITHOUT_TAX_EL,'.mapValue[','[')  where AMOUNT_WITHOUT_TAX_EL is not null and AMOUNT_WITHOUT_TAX_EL like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set AMOUNT_WITHOUT_TAX_EL=replace(AMOUNT_WITHOUT_TAX_EL,'.listValue','')  where AMOUNT_WITHOUT_TAX_EL is not null and AMOUNT_WITHOUT_TAX_EL like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set AMOUNT_WITH_TAX_EL=replace(AMOUNT_WITH_TAX_EL,'.mapValue[','[')  where AMOUNT_WITH_TAX_EL is not null and AMOUNT_WITH_TAX_EL like '%mv:%';
            update CAT_PRICE_PLAN_MATRIX set AMOUNT_WITH_TAX_EL=replace(AMOUNT_WITH_TAX_EL,'.listValue','')  where AMOUNT_WITH_TAX_EL is not null and AMOUNT_WITH_TAX_EL like '%mv:%';
            update BILLING_INV_SUB_CAT_COUNTRY set FILTER_EL=replace(FILTER_EL,'.mapValue[','[')  where FILTER_EL is not null and FILTER_EL like '%mv:%';
            update BILLING_INV_SUB_CAT_COUNTRY set FILTER_EL=replace(FILTER_EL,'.listValue','')  where FILTER_EL is not null and FILTER_EL like '%mv:%';
        </sql>
    </changeSet>
    <changeSet id="#1487_20150509" author="AndriusKarpavicius">
        <addColumn tableName="CRM_CUSTOM_FIELD_TMPL">
            <column name="CHE_FIELDS" type="VARCHAR(500)"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#1508_20160519" author="AndriusKarpavicius">
    
        <addColumn tableName="MEVEO_MODULE">        
            <column name="SCRIPT_INSTANCE_ID" type="BIGINT" />
            <column name="INSTALLED" type="BOOL" defaultValueBoolean="false"/>
            <column name="MODULE_SOURCE" type="TEXT" />
        </addColumn>
        
        <sql>update meveo_module set script_instance_id=(select script_instance_id from cat_business_offer_model where meveo_module.id=cat_business_offer_model.id)</sql>
        <sql>update meveo_module set script_instance_id=(select script_instance_id from cat_business_serv_model where meveo_module.id=cat_business_serv_model.id)</sql>
        <sql>update meveo_module set script_instance_id=(select script_instance_id from crm_business_account_model where meveo_module.id=crm_business_account_model.id)</sql>
        <sql>update meveo_module set installed=false</sql>
        
        <addForeignKeyConstraint baseColumnNames="script_instance_id"
            baseTableName="MEVEO_MODULE" constraintName="fk_meveo_module_script_instance"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
    
        <dropColumn tableName="cat_business_offer_model" columnName="script_instance_id"/>
        <dropColumn tableName="cat_business_serv_model" columnName="script_instance_id"/>
        <dropColumn tableName="crm_business_account_model" columnName="script_instance_id"/>    
        <addNotNullConstraint tableName="MEVEO_MODULE" columnName="INSTALLED"/>
    
    </changeSet>

    <changeSet author="AndriusKarpavicius" id="#1734_20150523">
        <createTable tableName="crm_custom_action">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
            <column name="disabled" type="BOOL">
                <constraints nullable="false" />
            </column>
            <column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="provider_id" type="BIGINT" />
            <column name="creator_id" type="BIGINT" />
            <column name="updater_id" type="BIGINT" />
            <column name="code" type="VARCHAR(60)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="VARCHAR(100)" />
            <column name="APPLIES_TO" type="varchar(100)"/>
            <column name="APPLICABLE_ON_EL" type="varchar(2000)"/>
            <column name="LABEL" type="varchar(50)"/>   
            <column name="SCRIPT_INSTANCE_ID" type="BIGINT" />
        </createTable>
        
        <addPrimaryKey columnNames="id" constraintName="crm_custom_action_pkey"
            tableName="crm_custom_action" />

        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="crm_custom_action" constraintName="fk_crm_custom_action_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
        
        <addForeignKeyConstraint baseColumnNames="creator_id"
            baseTableName="crm_custom_action" constraintName="fk_creator_crm_custom_action_adm_user"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
        
        <addForeignKeyConstraint baseColumnNames="updater_id"
            baseTableName="crm_custom_action" constraintName="fk_updater_crm_custom_action_adm_user"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
        
        <addForeignKeyConstraint baseColumnNames="script_instance_id"
            baseTableName="crm_custom_action" constraintName="fk_meveo_module_script_instance"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
        
        <addNotNullConstraint tableName="crm_custom_action" columnName="APPLIES_TO"/>
        <addNotNullConstraint tableName="crm_custom_action" columnName="script_instance_id"/>
                
        <createSequence sequenceName="crm_custom_action_seq" />
        
        <sql>insert into crm_custom_action (id, version, disabled, created, updated, provider_id, creator_id, updater_id, code, description, applies_to, applicable_on_el, label, script_instance_id)
                 (select nextval('crm_custom_action_seq'), version, disabled, created, updated, provider_id, creator_id, updater_id, code, description, applies_to, applicable_on_el, label, id from meveo_script_instance where script_type='EntityAction' )
        </sql>
        
        <dropColumn tableName="meveo_script_instance" columnName="script_type"/>
        <dropColumn tableName="meveo_script_instance" columnName="APPLIES_TO"/>
        <dropColumn tableName="meveo_script_instance" columnName="APPLICABLE_ON_EL"/>
        <dropColumn tableName="meveo_script_instance" columnName="label"/>
    </changeSet>

	<changeSet author="anasseh" id="#1688_20160520">
     	<modifyDataType columnName="DESCRIPTION" newDataType="VARCHAR(600)"   tableName="BILLING_INVOICE_AGREGATE"/>
     </changeSet>  
     
<!-- Begin InvoiceType evol -->    
  	<changeSet author="anasseh" id="#1685_20160510">
	    <createSequence sequenceName="billing_invoice_type_seq" />
		<createTable tableName="billing_invoice_type">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="disabled" type="BOOL">
				<constraints nullable="false" />
			</column>
			<column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
			<column name="provider_id" type="BIGINT" />
			<column name="creator_id" type="BIGINT" />
			<column name="updater_id" type="BIGINT" />
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(100)" />
			<column name="inv_type" type="VARCHAR(100)" />
			<column name="prefix" type="VARCHAR(2000)" />
			<column name="sequence_size" type="INT4" />
			<column name="matching_auto" type="BOOL" />
			<column name="occ_template_id" type="BIGINT" />
		</createTable>

		<addPrimaryKey columnNames="id" constraintName="billing_invoice_type_pkey"
			tableName="billing_invoice_type" />

		<addForeignKeyConstraint baseColumnNames="provider_id"
			baseTableName="billing_invoice_type" constraintName="fk_provider_id_billing_invoice_type"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
		
		<addForeignKeyConstraint baseColumnNames="creator_id"
			baseTableName="billing_invoice_type" constraintName="fk_creator_id_billing_invoice_type"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		
		<addForeignKeyConstraint baseColumnNames="updater_id"
			baseTableName="billing_invoice_type" constraintName="fk_updater_id_billing_invoice_type"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		
		<addForeignKeyConstraint baseColumnNames="occ_template_id"
			baseTableName="billing_invoice_type" constraintName="fk_occ_template_id_billing_invoice_type"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_occ_template" />
		
		<addUniqueConstraint columnNames="code, provider_id, occ_template_id" constraintName="uk_billing_invoice_type" deferrable="false" disabled="false"
            initiallyDeferred="false" tableName="billing_invoice_type" />				

		<createTable tableName="billing_invoice_type_applies_to">
			<column name="invoice_type_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="applies_to_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
		</createTable>
		
		<addForeignKeyConstraint baseColumnNames="invoice_type_id"
			baseTableName="billing_invoice_type_applies_to" constraintName="fk_invoice_type_id_billing_invoice_type_applies_to"
			deferrable="false" initiallyDeferred="false" onDelete="CASCADE"
			onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="billing_invoice_type" />
			
		<addForeignKeyConstraint baseColumnNames="applies_to_id"
			baseTableName="billing_invoice_type_applies_to" constraintName="fk_applies_to_id_billing_invoice_type_applies_to"
			deferrable="false" initiallyDeferred="false" onDelete="CASCADE"
			onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="billing_invoice_type" />			
	</changeSet>
	
	
	<changeSet id="#1695-20160512" author="anasseh">	
		<dropUniqueConstraint constraintName="billing_invoice_provider_id_invoice_number_invoice_type_key" tableName="billing_invoice" />
		
		<addColumn tableName="billing_invoice">
			<column name="invoice_type_id" type="BIGINT" />
		</addColumn>    
    
    	<addForeignKeyConstraint constraintName="fk_invoice_type_id_billing_invoice"
			referencedTableName="billing_invoice_type" baseColumnNames="invoice_type_id"
			baseTableName="billing_invoice" referencedColumnNames="id" />
			
		<addUniqueConstraint constraintName="uk_billing_invoice" columnNames="provider_id, invoice_number, invoice_type_id" tableName="billing_invoice" />
	</changeSet>	

     <changeSet author="anasseh" id="#1685_20160510_2">	   		
		 <renameColumn   newColumnName="prefix_el"  oldColumnName="prefix"  tableName="billing_invoice_type"/>
     </changeSet>
     
	<changeSet author="EdwardLegaspi" id="#1689_20160526">
		<createTable tableName="BILLING_LINKED_INVOICES">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="linked_invoice_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>
	
	<changeSet author="mhamidi" id="#1689_20160617">
		<createProcedure procedureName="adjusted_invoice_migration">
	    	CREATE OR REPLACE FUNCTION adjusted_invoice_migration()
	  		RETURNS void AS
			$BODY$
			declare
				cursorAdjustedInvoice cursor for
				select * from billing_invoice where invoice_id is not null ;
			invoiceRecord record;	
			begin
				open cursorAdjustedInvoice;
				loop
				fetch cursorAdjustedInvoice into invoiceRecord;
				exit when not found;
			
				insert into billing_linked_invoices (id, linked_invoice_id) values(invoiceRecord.invoice_id, invoiceRecord.id);
				insert into billing_linked_invoices (id, linked_invoice_id) values(invoiceRecord.id,invoiceRecord.invoice_id);
				
				end loop;
				close cursorAdjustedInvoice;
			end;
			$BODY$
	  		LANGUAGE plpgsql VOLATILE
	  		COST 100;	
    	</createProcedure>
    	
    	<sql>select adjusted_invoice_migration()</sql>
    	<sql>drop FUNCTION adjusted_invoice_migration()</sql> 
    </changeSet>
     
    <changeSet author="anasseh (generated)" id="#1685_20160530-2">
        <createTable tableName="billing_seq_invtyp_sell">
            <column name="invoicetype_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="currentinvoicenb" type="BIGINT"/>
            <column name="prefixel" type="VARCHAR(255)"/>
            <column name="sequencesize" type="INT4"/>
            <column name="seller_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
 
    <changeSet author="anasseh (generated)" id="#1685_20160530-5">
        <addColumn tableName="billing_invoice_type">
            <column name="current_invoice_nb" type="int8"/>
        </addColumn>
    </changeSet>


    <changeSet author="anasseh (generated)" id="#1685_20160530-11">
        <addPrimaryKey columnNames="invoicetype_id, seller_id" constraintName="billing_seq_invtyp_sell_pkey" tableName="billing_seq_invtyp_sell"/>
    </changeSet>

    <changeSet author="anasseh (generated)" id="#1685_20160530-23">
        <addForeignKeyConstraint baseColumnNames="invoicetype_id" baseTableName="billing_seq_invtyp_sell" constraintName="fk_2rjk30cy77bs2jxqwsbrhk6qb" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_type"/>
    </changeSet>

    <changeSet author="anasseh (generated)" id="#1685_20160530-43">
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="billing_seq_invtyp_sell" constraintName="fk_ivmab13iml7v0n29giw9w8kor" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller"/>
    </changeSet>


    <changeSet author="anasseh" id="aFix__20160614">
        <sql>SELECT setval('ar_occ_template_seq', (SELECT MAX(id) FROM ar_occ_template))</sql>
    </changeSet>
     
     <changeSet author="anasseh" id="#1696_20160601">
    <createProcedure  procedureName="invoice_type_migration">
CREATE OR REPLACE FUNCTION invoice_type_migration()
  RETURNS void AS
$BODY$
			declare
			cursorProv cursor for
			select * from crm_provider;			
			providerRecord record;
			id_occ_com 	BIGINT;
			id_occ_adj  BIGINT;
			creator_id  BIGINT;
			begin
			open cursorProv;
			loop
			fetch cursorProv into providerRecord;
			exit when not found;
			select  u.id into creator_id from adm_user u, adm_user_role r where u.provider_id = providerRecord.id and  r.user_id = u.id and r.role_id=1  limit 1;
			IF( (select count(id) from AR_OCC_TEMPLATE where code ='FAI' and provider_id=providerRecord.id) = 0)THEN
				IF( (select count(id) from AR_OCC_TEMPLATE where code ='FA_FACT' and provider_id=providerRecord.id) =0)THEN
			  			id_occ_com = nextval('AR_OCC_TEMPLATE_SEQ');
			  			INSERT INTO ar_occ_template( id, version, disabled, created, updated, account_code, account_code_client_side, 
                        code, description, occ_category, provider_id, creator_id, updater_id)
                        VALUES (id_occ_com, 1, false, current_timestamp, null, null, null,'FA_FACT','Invoice OCC','DEBIT',
                         providerRecord.id, creator_id, null);
                 ELSE
                       select id into id_occ_com from AR_OCC_TEMPLATE where code ='FA_FACT' and provider_id=providerRecord.id;
                       select cc.creator_id into creator_id from AR_OCC_TEMPLATE cc where cc.code ='FA_FACT' and cc.provider_id=providerRecord.id;
                 END IF;  
             ELSE
                   select id into id_occ_com from AR_OCC_TEMPLATE where code ='FAI' and provider_id=providerRecord.id;    
                   select cc.creator_id into creator_id from AR_OCC_TEMPLATE cc where cc.code ='FAI' and cc.provider_id=providerRecord.id;
             END IF;  
              
			IF( (select count(id) from AR_OCC_TEMPLATE where code ='AVI' and provider_id=providerRecord.id) = 0 )THEN
				IF( (select count(id) from AR_OCC_TEMPLATE where code ='FA_ADJ' and provider_id=providerRecord.id) = 0)THEN
			  			id_occ_adj = nextval('AR_OCC_TEMPLATE_SEQ');
			  			INSERT INTO ar_occ_template( id, version, disabled, created, updated, account_code, account_code_client_side, 
                        code, description, occ_category, provider_id, creator_id, updater_id)
                        VALUES (id_occ_adj, 1, false, current_timestamp, null, null, null,'FA_ADJ','Adjustement OCC','CREDIT',
                         providerRecord.id, creator_id, null);
                 ELSE
                       select id into id_occ_adj from AR_OCC_TEMPLATE where code ='FA_ADJ' and provider_id=providerRecord.id;
                       select cc.creator_id into creator_id from AR_OCC_TEMPLATE cc where cc.code ='FA_ADJ' and cc.provider_id=providerRecord.id;
                 END IF;  
             ELSE
                    select id into id_occ_adj from AR_OCC_TEMPLATE where code ='AVI' and provider_id=providerRecord.id;    
                    select cc.creator_id into creator_id from AR_OCC_TEMPLATE cc where cc.code ='AVI' and cc.provider_id=providerRecord.id;
             END IF;             

			INSERT INTO billing_invoice_type(
            id, version, disabled, created, updated, provider_id, creator_id, 
            updater_id, code, description, prefix_el, sequence_size,current_invoice_nb, matching_auto, 
            occ_template_id)
            VALUES ( nextval('BILLING_INVOICE_TYPE_SEQ'), 1, providerRecord.disabled, current_timestamp, null, providerRecord.id, creator_id,
             null, 'COM','Commercial',providerRecord.INVOICE_PREFIX , providerRecord.INVOICE_SEQUENCE_SIZE, providerRecord.CURRENT_INVOICE_NB, false,
              id_occ_com);

            INSERT INTO billing_invoice_type(
            id, version, disabled, created, updated, provider_id, creator_id, 
            updater_id, code, description, prefix_el, sequence_size,current_invoice_nb, matching_auto, 
            occ_template_id)
            VALUES ( nextval('BILLING_INVOICE_TYPE_SEQ'), 1, providerRecord.disabled, current_timestamp, null,  providerRecord.id, creator_id,
             null, 'ADJ','Adjustement',providerRecord.INVOICE_ADJUSTMENT_PREFIX , providerRecord.INVOICE_ADJUSTMENT_SEQUENCE_SIZE, providerRecord.CURRENT_INVOICE_ADJUSTMENT_NB, false, 
             id_occ_adj);
             
             INSERT INTO billing_invoice_type_applies_to(invoice_type_id, applies_to_id) VALUES ((select id from billing_invoice_type where code='COM' and provider_id = providerRecord.id ) , (select id from billing_invoice_type where code='ADJ' and provider_id = providerRecord.id ));
              INSERT INTO billing_invoice_type_applies_to(invoice_type_id, applies_to_id) VALUES ((select id from billing_invoice_type where code='ADJ' and provider_id = providerRecord.id ),(select id from billing_invoice_type where code='COM' and provider_id = providerRecord.id ) );

            
			end loop;
			close cursorProv;
			end;
			$BODY$
  LANGUAGE plpgsql VOLATILE
  COST 100;
    </createProcedure>
    
        <createProcedure  procedureName="invoice_type_migration2">
CREATE OR REPLACE FUNCTION invoice_type_migration2()
  RETURNS void AS
$BODY$
			declare
			cursorSellerCOM cursor for
			select * from crm_seller where invoice_prefix is  not null ;		
			cursorSellerADJ cursor for
			select * from crm_seller where invoice_adjustment_prefix is  not null;					
			sellerRecord record;
			begin
			
			open cursorSellerCOM;
			loop
			fetch cursorSellerCOM into sellerRecord;
			exit when not found;
			
			insert into billing_seq_invtyp_sell (invoicetype_id,currentinvoicenb,prefixel,sequencesize,seller_id) 
			values((select id from billing_invoice_type where code='COM' and provider_id = sellerRecord.provider_id ),sellerRecord.current_invoice_nb ,sellerRecord.invoice_prefix,sellerRecord.invoice_sequence_size,sellerRecord.id);
			
			end loop;
			close cursorSellerCOM;
			
			open cursorSellerADJ;
			loop
			fetch cursorSellerADJ into sellerRecord;
			exit when not found;
			
			insert into billing_seq_invtyp_sell (invoicetype_id,currentinvoicenb,prefixel,sequencesize,seller_id) 
			values((select id from billing_invoice_type where code='ADJ' and provider_id = sellerRecord.provider_id),sellerRecord.current_invoice_adjustment_nb ,sellerRecord.invoice_adjustment_prefix,sellerRecord.invoice_adjustment_sequence_size,sellerRecord.id);
			
			end loop;
			close cursorSellerADJ;			
			end;
			$BODY$
  LANGUAGE plpgsql VOLATILE
  COST 100;
    </createProcedure>
    <sql>select invoice_type_migration()</sql>
    <sql>select invoice_type_migration2()</sql>
    <sql>drop FUNCTION invoice_type_migration()</sql> 
    <sql>drop FUNCTION invoice_type_migration2()</sql> 
</changeSet>


    <changeSet author="anasseh (generated)" id="#1685_20160530-86">
        <dropColumn columnName="current_invoice_adjustment_nb" tableName="crm_provider"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1685_20160530-87">
        <dropColumn columnName="current_invoice_adjustment_nb" tableName="crm_seller"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1685_20160530-88">
        <dropColumn columnName="current_invoice_nb" tableName="crm_provider"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1685_20160530-89">
        <dropColumn columnName="current_invoice_nb" tableName="crm_seller"/>
    </changeSet>

    <changeSet author="anasseh (generated)" id="#1685_20160530-92">
        <dropColumn columnName="inv_type" tableName="billing_invoice_type"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1685_20160530-93">
        <dropColumn columnName="invoice_adjustment_prefix" tableName="crm_provider"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1685_20160530-94">
        <dropColumn columnName="invoice_adjustment_prefix" tableName="crm_seller"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1685_20160530-95">
        <dropColumn columnName="invoice_adjustment_sequence_size" tableName="crm_provider"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1685_20160530-96">
        <dropColumn columnName="invoice_adjustment_sequence_size" tableName="crm_seller"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1685_20160530-97">
        <dropColumn columnName="invoice_prefix" tableName="crm_provider"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1685_20160530-98">
        <dropColumn columnName="invoice_prefix" tableName="crm_seller"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1685_20160530-99">
        <dropColumn columnName="invoice_sequence_size" tableName="crm_provider"/>
    </changeSet>
    <changeSet author="anasseh (generated)" id="#1685_20160530-100">
        <dropColumn columnName="invoice_sequence_size" tableName="crm_seller"/>
    </changeSet>
    
   <changeSet author="anasseh" id="#1696_20160601_2">
    <createProcedure  procedureName="update_old_invoice_entities">
CREATE OR REPLACE FUNCTION update_old_invoice_entities()
  RETURNS void AS
$BODY$
			declare
			cursorInv cursor for
			select * from billing_invoice where invoice_type is not null;			
			invRecord record;
			begin
			open cursorInv;
			loop
			fetch cursorInv into invRecord;
			exit when not found;
						
			IF( invRecord.invoice_type = 'COMMERCIAL')THEN
				update billing_invoice set invoice_type_id = (select id from billing_invoice_type where code='COM' and provider_id = invRecord.provider_id ) where id = invRecord.id ;
             ELSE
                  update billing_invoice set invoice_type_id = (select id from billing_invoice_type where code='ADJ' and provider_id = invRecord.provider_id ) where id = invRecord.id;
             END IF;  
              		
			end loop;
			close cursorInv;
			end;
			$BODY$
  LANGUAGE plpgsql VOLATILE
  COST 100;
    </createProcedure>
    

    <sql>select update_old_invoice_entities()</sql>
    <sql>drop FUNCTION update_old_invoice_entities()</sql> 

</changeSet>
 
    <changeSet author="anasseh (generated)" id="#1685_20160530-101">
        <dropColumn columnName="invoice_type" tableName="billing_invoice"/>
    </changeSet>   
<!-- Begin InvoiceType evol -->        	   
    	
	<changeSet id="#1700-20160601" author="anasseh">			
		<addColumn tableName="billing_cycle">
			<column name="invoice_type_id" type="BIGINT" />
		</addColumn>
		<addForeignKeyConstraint constraintName="fk_invoice_type_id_billing_cycle"
			referencedTableName="billing_invoice_type" baseColumnNames="invoice_type_id"
			baseTableName="billing_cycle" referencedColumnNames="id" />
		</changeSet>
		
	<changeSet id="#1679_20160602" author="EdwardLegaspi">
		<renameColumn tableName="crm_business_account_model" oldColumnName="type" newColumnName="hierarchy_type"/>
	</changeSet>
	
	<changeSet id="#1422_20160602" author="anasseh">			
     	<modifyDataType columnName="report" newDataType="text"   tableName="job_execution"/>
	</changeSet>
	
	<changeSet id="#1760-20160602" author="anasseh">			
		<addColumn tableName="billing_invoice_type">
			<column name="occ_templ_negative_id" type="BIGINT" />
		</addColumn>    
    
		<addForeignKeyConstraint baseColumnNames="occ_templ_negative_id"
			baseTableName="billing_invoice_type" constraintName="fk_occ_templ_negative_id_billing_invoice_type"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_occ_template" />
	</changeSet>

	<changeSet id="1026_20160530" author="TonyAlejandro">
		<addColumn tableName="meveo_filter">
			<column name="UUID" type="VARCHAR(60)" />
		</addColumn>
	</changeSet>
	    	
	<changeSet id="#1786_20160616" author="smichea">
		<addColumn tableName="cat_triggered_edr">
			<column name="meveo_instance_id" type="BIGINT" />
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="meveo_instance_id"
			baseTableName="cat_triggered_edr" constraintName="fk_meveo_instance_id_com_meveo_instance"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="com_meveo_instance" />
		
	</changeSet>
	
	<changeSet id="#1774_20160725" author="smichea">
		<addColumn tableName="cat_price_plan_matrix">
			<column name="script_instance_id" type="BIGINT" />
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="script_instance_id"
			baseTableName="cat_price_plan_matrix" constraintName="fk_priceplan_script"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
	</changeSet>
	<changeSet id="#1889_20160729" author="Mbarek">
	    <addColumn tableName="BILLING_TAX">
        <column name="UUID" type="VARCHAR(50)"/>
        </addColumn>
     </changeSet>
     <changeSet id="#1890_20160801" author="Mbarek">
	      <addColumn tableName="BILLING_CYCLE">
          <column name="UUID" type="VARCHAR(50)"/>
        </addColumn>
       	<addColumn tableName="BILLING_INVOICE_CONFIGURATION">
			<column name="DISPLAY_BILLING_CYCLE" type="BOOL" defaultValueBoolean="false"></column> 
		</addColumn> 
     </changeSet>
     
      <changeSet id="#1890_#1889_UIID_20160801" author="Mbarek">
         <sql>update BILLING_TAX set UUID ='TAX-'|| id </sql>   
        <sql>update BILLING_CYCLE set UUID ='BillingCycle-'|| id </sql> 
        </changeSet>
            
    <changeSet id="#20171123" author="smichea">
        <addColumn tableName="CAT_DISCOUNT_PLAN_ITEM">
            <column name="DISCOUNT_PERCENT_EL" type="VARCHAR(2000)"/>        
        </addColumn>
    </changeSet>
        
</databaseChangeLog>